<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      :root { color-scheme: light dark; }
      body { font-family: Arial, sans-serif; padding: 24px; }
      nav a { margin-right: 12px; display: inline-block; padding: 6px 8px; }
      label { display: block; margin-top: 12px; }
      input, textarea, select { width: 100%; padding: 10px; box-sizing: border-box; }
      button { margin-top: 16px; padding: 10px 16px; }
      .table-wrap { width: 100%; overflow-x: auto; }
      table { width: 100%; min-width: 640px; border-collapse: collapse; margin-top: 16px; }
      th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
      h2 { margin-top: 24px; }

      @media (max-width: 600px) {
        body { padding: 16px; }
        nav a { margin-bottom: 6px; font-size: 14px; }
        button { width: 100%; }
        label { margin-top: 10px; }
      }
      @media (prefers-color-scheme: dark) {
        body { background:#111; color:#eaeaea; }
        th, td { border-bottom:1px solid #333; }
        input, textarea, select { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
        button { background:#2a2a2a; color:#eaeaea; border:1px solid #444; }
        nav a { color:#8ab4ff; }
      }
      body.theme-dark { background:#111; color:#eaeaea; }
      body.theme-dark th, body.theme-dark td { border-bottom:1px solid #333; }
      body.theme-dark input, body.theme-dark textarea, body.theme-dark select { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
      body.theme-dark button { background:#2a2a2a; color:#eaeaea; border:1px solid #444; }
      body.theme-dark nav a { color:#8ab4ff; }
      body.theme-light { background:#fff; color:#111; }
    </style>
    <script>
      function applyTheme(pref){ document.body.classList.remove('theme-dark','theme-light'); if(pref==='dark')document.body.classList.add('theme-dark'); if(pref==='light')document.body.classList.add('theme-light'); }
      function updateThemeButton(pref){ const b=document.getElementById('themeToggleBtn'); if(b) b.textContent = pref==='dark'?'テーマ: ダーク':(pref==='light'?'テーマ: ライト':'テーマ: 自動'); }
      function initTheme(){ const p=localStorage.getItem('theme')||'system'; applyTheme(p); updateThemeButton(p); }
      function toggleTheme(){ const cur=localStorage.getItem('theme')||'system'; const next=cur==='system'?'dark':(cur==='dark'?'light':'system'); localStorage.setItem('theme',next); applyTheme(next); updateThemeButton(next); }
      window.addEventListener('load', initTheme);
    </script>
    <script>
      function submitFacility() {
        const data = {
          name: document.getElementById('name').value,
          prefecture: document.getElementById('prefectureSelect').value,
          municipality: document.getElementById('municipalitySelect').value,
          facilityType: (function(){
            const sel = document.getElementById('facilityTypeSelect');
            if (sel.value === 'その他') {
              const other = document.getElementById('facilityTypeOther').value.trim();
              if (!other) { alert('その他詳細を入力してください'); throw new Error('missing facilityTypeOther'); }
              return 'その他:' + other;
            }
            return sel.value;
          })(),
          address: document.getElementById('address').value,
          phone: document.getElementById('phone').value,
          notes: document.getElementById('notes').value
        };
        if (!data.name) { alert('施設名を入力してください'); return; }
        if (!data.prefecture) { alert('都道府県を選択してください'); return; }
        if (!data.municipality) { alert('市区町村を選択してください'); return; }
        if (!data.facilityType) { alert('事業所種類を選択してください'); return; }
        if (!data.address) { alert('住所を入力してください'); return; }
        if (!data.phone) { alert('電話番号を入力してください'); return; }
        google.script.run.withSuccessHandler(function() {
          alert('施設を登録しました');
          document.getElementById('facilityForm').reset();
          loadFacilities();
        }).addFacility(data);
      }

      function loadFacilities() {
        google.script.run.withSuccessHandler(function(list) {
          const tbody = document.getElementById('facilityRows');
          if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">登録された施設はまだありません</td></tr>';
            return;
          }
          let html = '';
          list.forEach(function(f) {
            html += '<tr><td>' + escapeHtml(f.name) + '</td>' +
                    '<td>' + escapeHtml(f.prefecture || '') + '</td>' +
                    '<td>' + escapeHtml(f.municipality || '') + '</td>' +
                    '<td>' + escapeHtml(f.facilityType || '') + '</td>' +
                    '<td>' + escapeHtml(f.address) + '</td>' +
                    '<td>' + escapeHtml(f.phone || '') + '</td></tr>';
          });
          tbody.innerHTML = html;
        }).getFacilities();
      }
      function loadMunicipalities(pref) {
        const sel = document.getElementById('municipalitySelect');
        sel.innerHTML = '<option value="">読み込み中...</option>';
        if (!pref) { sel.innerHTML = '<option value="">-- 先に都道府県を選択 --</option>'; return; }
        google.script.run.withSuccessHandler(function(list) {
          sel.innerHTML = '<option value="">-- 市区町村を選択 --</option>';
          list.forEach(function(m) {
            const opt = document.createElement('option');
            opt.value = m.municipality;
            opt.textContent = m.municipality;
            sel.appendChild(opt);
          });
        }).getMunicipalities({ prefecture: pref });
      }

      function addMunicipalityEntry() {
        const pref = document.getElementById('prefectureSelect').value;
        const mun = document.getElementById('municipalityNew').value.trim();
        if (!pref) { alert('先に都道府県を選択してください'); return; }
        if (!mun) { alert('市区町村名を入力してください'); return; }
        google.script.run.withSuccessHandler(function(res){
          document.getElementById('municipalityNew').value = '';
          loadMunicipalities(pref);
          alert(res.existed ? '既に登録されています' : '市区町村を追加しました');
        }).addMunicipality({ prefecture: pref, municipality: mun });
      }

      // 市区町村マスタの再投入（不足分のみ追加）
      function seedMunicipalitiesFromServer() {
        const pref = document.getElementById('prefectureSelect').value;
        google.script.run.withSuccessHandler(function(res){
          if (pref) loadMunicipalities(pref);
          alert('市区町村マスタを更新しました（追加: ' + (res && res.inserted || 0) + '件）');
        }).seedMunicipalitiesMerge();
      }

      window.addEventListener('load', function(){
        document.getElementById('prefectureSelect').addEventListener('change', function(){
          loadMunicipalities(this.value);
        });
        document.getElementById('facilityTypeSelect').addEventListener('change', function(){
          if (this.value === 'その他') {
            document.getElementById('facilityTypeOtherWrap').style.display = 'block';
          } else {
            document.getElementById('facilityTypeOtherWrap').style.display = 'none';
            document.getElementById('facilityTypeOther').value = '';
          }
        });
      });

      function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }

      window.addEventListener('load', function() {
        loadFacilities();
      });
    </script>
  </head>
  <body>
    <nav>
      <!-- 絶対URL化で /blank ベース解決の不具合を回避 -->
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=index">メニューに戻る</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=manage">施設・担当者 管理</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=visits">問い合わせ記録</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=reports">営業報告</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=employees">社員登録</a>
      <button id="themeToggleBtn" type="button" style="float:right;" onclick="toggleTheme()">テーマ: 自動</button>
    </nav>

    <h1>施設登録</h1>
    <form id="facilityForm" onsubmit="event.preventDefault(); submitFacility();">
      <label for="name">施設名</label>
      <input type="text" id="name" required>
      <label for="prefectureSelect">都道府県（関東）</label>
      <select id="prefectureSelect" required>
        <option value="">-- 選択 --</option>
        <option value="東京都">東京都</option>
        <option value="神奈川県">神奈川県</option>
        <option value="千葉県">千葉県</option>
        <option value="埼玉県">埼玉県</option>
        <option value="茨城県">茨城県</option>
        <option value="栃木県">栃木県</option>
        <option value="群馬県">群馬県</option>
        <option value="山梨県">山梨県</option>
      </select>
      <label for="municipalitySelect">市区町村</label>
      <select id="municipalitySelect" required>
        <option value="">-- 先に都道府県を選択 --</option>
      </select>
      <div style="margin-top:8px;">
        <label for="municipalityNew">市区町村が一覧に無い場合は追加</label>
        <input type="text" id="municipalityNew" placeholder="例: 千代田区" />
        <button type="button" onclick="addMunicipalityEntry()">市区町村を追加</button>
        <button type="button" onclick="seedMunicipalitiesFromServer()" style="margin-left:8px;">関東市区町村を読み込む</button>
      </div>
      <label for="facilityTypeSelect">事業所種類</label>
      <select id="facilityTypeSelect" required>
        <option value="">-- 選択 --</option>
        <optgroup label="高齢者系">
          <option value="居宅介護支援">居宅介護支援</option>
          <option value="訪問介護">訪問介護</option>
          <option value="通所介護">通所介護</option>
          <option value="訪問看護">訪問看護</option>
          <option value="看護小規模多機能">看護小規模多機能</option>
          <option value="特別養護老人ホーム">特別養護老人ホーム</option>
          <option value="有料老人ホーム">有料老人ホーム</option>
          <option value="サービス付高齢者住宅">サービス付高齢者住宅</option>
        </optgroup>
        <optgroup label="障害福祉（成人）">
          <option value="就労移行支援">就労移行支援</option>
          <option value="就労継続支援A型">就労継続支援A型</option>
          <option value="就労継続支援B型">就労継続支援B型</option>
          <option value="就労定着支援">就労定着支援</option>
          <option value="生活介護">生活介護</option>
          <option value="自立訓練（生活訓練）">自立訓練（生活訓練）</option>
          <option value="自立訓練（機能訓練）">自立訓練（機能訓練）</option>
          <option value="共同生活援助（グループホーム）">共同生活援助（グループホーム）</option>
          <option value="短期入所（ショートステイ）">短期入所（ショートステイ）</option>
          <option value="居宅介護（障害）">居宅介護（障害）</option>
          <option value="重度訪問介護">重度訪問介護</option>
          <option value="同行援護">同行援護</option>
          <option value="行動援護">行動援護</option>
          <option value="移動支援">移動支援</option>
          <option value="施設入所支援">施設入所支援</option>
        </optgroup>
        <optgroup label="相談支援">
          <option value="特定相談支援（計画相談）">特定相談支援（計画相談）</option>
          <option value="障害児相談支援">障害児相談支援</option>
        </optgroup>
        <optgroup label="児童・療育">
          <option value="児童発達支援">児童発達支援</option>
          <option value="放課後等デイサービス">放課後等デイサービス</option>
          <option value="保育所等訪問支援">保育所等訪問支援</option>
          <option value="児童発達支援センター">児童発達支援センター</option>
        </optgroup>
        <optgroup label="その他・関連機関">
          <option value="ケアマネ">ケアマネ</option>
          <option value="医療機関">医療機関</option>
          <option value="行政機関">行政機関</option>
          <option value="その他">その他</option>
        </optgroup>
      </select>
      <div id="facilityTypeOtherWrap" style="display:none;">
        <label for="facilityTypeOther">その他詳細</label>
        <input type="text" id="facilityTypeOther" placeholder="種類を入力" />
      </div>
      <label for="address">住所</label>
      <input type="text" id="address" required>
      <label for="phone">電話番号</label>
      <input type="text" id="phone" required>
      <label for="notes">備考</label>
      <textarea id="notes" rows="4"></textarea>
      <button type="submit">登録する</button>
    </form>

    <h2>登録済み施設</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>施設名</th><th>都道府県</th><th>市区町村</th><th>種類</th><th>住所</th><th>電話番号</th></tr>
        </thead>
        <tbody id="facilityRows">
          <tr><td colspan="6">読み込み中...</td></tr>
        </tbody>
      </table>
    </div>
  </body>
</html>
