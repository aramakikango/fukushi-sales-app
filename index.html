<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
      :root { color-scheme: light dark; }

      /* ===== Base Layout ===== */
      *, *::before, *::after { box-sizing: border-box; }
      html, body { width:100%; max-width:100%; overflow-x:hidden; }

      body {
        font-family: Arial, sans-serif;
        padding: 40px;
        margin: 0;
      }

      h1 {
        margin: 10px 0 12px;
        font-size: 22px;
      }

      p {
        margin: 0 0 12px;
        font-size: 15px;
      }

      .muted {
        opacity: 0.7;
        font-size: 14px;
      }

      /* ===== Menu List ===== */
      .menu-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 14px;
        max-width: 480px;
      }
        .menu-list {
          max-width: 100%;
        }

      .menu-item {
        display: block;
        width: 100%;
        padding: 18px 22px;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        text-decoration: none;
        border-radius: 12px;
        border: 2px solid var(--border);
        color: var(--textLink);
        background: var(--btnBg);
        transition: all .2s;
        min-height: 60px;
      }
        .menu-item {
          min-height: clamp(56px, 10vh, 72px);
          font-size: clamp(16px, 2.8vw + 12px, 20px);
        }

      .menu-item:hover,
      .menu-item:active {
        background: var(--btnHoverBg);
        color: var(--btnHoverText);
      }

      /* ===== Theme Button ===== */
      .theme-wrap {
        max-width: 480px;
        margin-bottom: 16px;
      }

      /* compact floating theme toggle (icon) */
      #themeToggleBtn {
        width:44px; height:44px; display:flex; align-items:center; justify-content:center;
        position:fixed; top:12px; right:12px; z-index:9999;
        border-radius:999px; border:2px solid rgba(55,103,230,0.12);
        background:var(--btnBg); color:var(--textLink); box-shadow:0 2px 6px rgba(0,0,0,0.08); cursor:pointer;
        font-size:18px; line-height:1; transition: transform .12s ease;
      }
      #themeToggleBtn:hover { transform:scale(1.06); }

      /* ===== Light Theme Variables ===== */
      body.theme-light {
        --bg: #fff;
        --text: #111;
        --textLink: #0c66d4;
        --border: #0c66d4;
        --btnBg: #fff;
        --btnHoverBg: #0c66d4;
        --btnHoverText: #fff;
        --panelBg: #fdfdfd;
      }

      /* ===== Dark Theme Variables ===== */
      body.theme-dark {
        --bg: #111;
        --text: #eaeaea;
        --textLink: #8ab4ff;
        --border: #3769e6;
        --btnBg: #1b1b1b;
        --btnHoverBg: #1f3a75;
        --btnHoverText: #fff;
        --panelBg: #161616;
      }

      /* ===== System Dark Mode ===== */
      @media (prefers-color-scheme: dark) {
        body:not(.theme-light):not(.theme-dark) {
          --bg: #111;
          --text: #eaeaea;
          --textLink: #8ab4ff;
          --border: #3769e6;
          --btnBg: #1b1b1b;
          --btnHoverBg: #1f3a75;
          --btnHoverText: #fff;
        }
      }

      /* Apply theme vars */
      body {
        background: var(--bg);
        color: var(--text);
      }

      .analytics-section {
        margin-top: 32px;
        max-width: 980px;
      }

      .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 16px;
        margin-top: 12px;
      }

      .analytics-card {
        border: 1px solid var(--border);
        border-radius: 14px;
        background: var(--panelBg, #fff);
        padding: 18px;
        box-shadow: 0 10px 25px rgba(15,23,42,0.08);
      }

      .analytics-card h3 {
        margin: 0 0 10px;
        font-size: 18px;
      }

      .analytics-card ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
        font-size: 14px;
      }

      .analytics-card li {
        color: var(--text);
      }

      .analytics-card .muted-link {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-top: 12px;
        font-size: 13px;
        color: var(--textLink);
      }

      /* ===== Mobile Optimized ===== */
      @media (max-width: 600px) {
        body { padding: 12px; }

        h1 { font-size: 20px; }

        .menu-item,
        #themeToggleBtn {
          padding: 20px;
          font-size: 19px;
          min-height: 64px;
          border-radius: 12px;
        }
      }
        @media (max-width: 600px) {
          .menu-item {
            padding-block: clamp(14px, 2vh, 18px);
          }
          #themeToggleBtn {
            padding-block: clamp(14px, 2vh, 18px);
          }
        }
    </style>

    <script>
      function applyTheme(pref) {
        document.body.classList.remove("theme-dark", "theme-light");
        if (pref === "dark") document.body.classList.add("theme-dark");
        if (pref === "light") document.body.classList.add("theme-light");
      }

      function updateThemeButton(pref) {
        const btn = document.getElementById("themeToggleBtn"); if (!btn) return;
        if (pref === 'dark') { btn.innerHTML = 'ğŸŒ™'; btn.title = 'ãƒ†ãƒ¼ãƒ: ãƒ€ãƒ¼ã‚¯'; btn.setAttribute('aria-label','ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰'); }
        else if (pref === 'light') { btn.innerHTML = 'â˜€ï¸'; btn.title = 'ãƒ†ãƒ¼ãƒ: ãƒ©ã‚¤ãƒˆ'; btn.setAttribute('aria-label','ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰'); }
        else { btn.innerHTML = 'ğŸŒ“'; btn.title = 'ãƒ†ãƒ¼ãƒ: è‡ªå‹•'; btn.setAttribute('aria-label','ãƒ†ãƒ¼ãƒ: è‡ªå‹•'); }
      }

      function initTheme() {
        const pref = localStorage.getItem("theme") || "system";
        applyTheme(pref);
        updateThemeButton(pref);
      }

      function toggleTheme() {
        const cur = localStorage.getItem("theme") || "system";
        const next = cur === "system" ? "dark" :
                     cur === "dark"   ? "light" : "system";
        localStorage.setItem("theme", next);
        applyTheme(next);
        updateThemeButton(next);
      }

      function loadAnalytics() {
        const params = { facilityType: 'å…±åŒç”Ÿæ´»æ´åŠ©ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ ï¼‰', limit: 5 };
        google.script.run.withSuccessHandler(renderTopReferrals).getFacilityReferralSummary(params);
        google.script.run.withSuccessHandler(renderLatestVisits).getLatestVisitsSummary(params);
      }

      function renderTopReferrals(list) {
        const container = document.getElementById('topReferralList');
        if (!container) return;
        if (!list || !list.length) {
          container.innerHTML = '<li>è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</li>';
          return;
        }
        container.innerHTML = list.map(function(item, index){
          const rank = index + 1;
          const label = escapeHtml(item.facilityName || 'æ–½è¨­ãªã—');
          const referred = item.referralCount || 0;
          const visits = item.visitCount || 0;
          const last = formatDateForDisplay(item.lastReferralDate || item.lastVisitDate);
          return '<li><strong>' + rank + '. ' + label + '</strong><br>'
            + 'ç´¹ä»‹ ' + referred + 'ä»¶ / è¨ªå• ' + visits + 'ä»¶'
            + (last ? ('ï¼ˆæœ€çµ‚: ' + escapeHtml(last) + 'ï¼‰') : '')
            + '</li>';
        }).join('');
      }

      function renderLatestVisits(list) {
        const container = document.getElementById('latestVisitList');
        if (!container) return;
        if (!list || !list.length) {
          container.innerHTML = '<li>è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</li>';
          return;
        }
        container.innerHTML = list.map(function(item){
          const dateLabel = formatDateForDisplay(item.visitDate);
          const name = escapeHtml(item.facilityName || 'æ–½è¨­ä¸æ˜');
          const purpose = escapeHtml(item.visitPurpose || item.inquiryType || 'å†…å®¹ãªã—');
          return '<li><strong>' + (dateLabel || 'æ—¥æ™‚ä¸æ˜') + '</strong><br>'
            + name + ' / ' + purpose + '</li>';
        }).join('');
      }

      function escapeHtml(str) {
        if (!str) return '';
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }

      function formatDateForDisplay(value) {
        if (!value) return '';
        const date = new Date(value);
        if (isNaN(date.getTime())) return escapeHtml(value);
        return date.toLocaleString();
      }

      window.addEventListener("load", function(){
        initTheme();
        loadAnalytics();
      });
    </script>
  </head>

  <body>
    <div class="theme-wrap">
      <button id="themeToggleBtn" onclick="toggleTheme()" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ“</button>
    </div>

    <h1>å–¶æ¥­ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h1>
    <p>åˆ©ç”¨ã—ãŸã„æ©Ÿèƒ½ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>

    <ul class="menu-list">
      <li><a class="menu-item" href="<?= ScriptApp.getService().getUrl(); ?>?page=reports">å–¶æ¥­å ±å‘Š</a></li>
      <li><a class="menu-item" href="<?= ScriptApp.getService().getUrl(); ?>?page=facilities">æ–½è¨­ç™»éŒ²</a></li>
      <li><a class="menu-item" href="<?= ScriptApp.getService().getUrl(); ?>?page=targets">å–¶æ¥­å…ˆæ¤œç´¢</a></li>
      <li><a class="menu-item" href="<?= ScriptApp.getService().getUrl(); ?>?page=partners">ç´¹ä»‹ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</a></li>
      <li><a class="menu-item" href="<?= ScriptApp.getService().getUrl(); ?>?page=manage">æ–½è¨­ãƒ»æ‹…å½“è€… ç®¡ç†</a></li>
      <li><a class="menu-item" href="<?= ScriptApp.getService().getUrl(); ?>?page=visits">å•ã„åˆã‚ã›è¨˜éŒ²</a></li>
      <li><a class="menu-item" href="<?= ScriptApp.getService().getUrl(); ?>?page=employees">ç¤¾å“¡ç™»éŒ²</a></li>
    </ul>

    <section class="analytics-section">
      <h2>ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ å‘ã‘ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
      <p class="muted">ç›´è¿‘ã®å•ã„åˆã‚ã›ã¨ç´¹ä»‹ä»¶æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ç¢ºèªã—ã€å„ªå…ˆå¯¾å¿œå…ˆãŒã™ãåˆ†ã‹ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>
      <div class="analytics-grid">
        <article class="analytics-card">
          <h3>ç´¹ä»‹ä»¶æ•°ãƒˆãƒƒãƒ—ã®ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ </h3>
          <ul id="topReferralList"><li>èª­ã¿è¾¼ã¿ä¸­â€¦</li></ul>
          <a class="muted-link" href="<?= ScriptApp.getService().getUrl(); ?>?page=reports">å–¶æ¥­å ±å‘Šä¸€è¦§ã§è©³ç´°ã‚’è¦‹ã‚‹</a>
        </article>
        <article class="analytics-card">
          <h3>æœ€æ–°ã®å•ã„åˆã‚ã›</h3>
          <ul id="latestVisitList"><li>èª­ã¿è¾¼ã¿ä¸­â€¦</li></ul>
          <a class="muted-link" href="<?= ScriptApp.getService().getUrl(); ?>?page=visits">å•ã„åˆã‚ã›è¨˜éŒ²ã‚’é–‹ã</a>
        </article>
      </div>
    </section>
  </body>
</html>
