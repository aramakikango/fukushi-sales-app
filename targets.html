<!DOCTYPE html>
<html>
  <head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
      *, *::before, *::after { box-sizing: border-box; }
      html, body { width:100%; max-width:100%; overflow-x:hidden; }
  body { font-family: Arial, sans-serif; padding: 24px; margin: 0; }
      nav { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
      nav a { margin-right: 12px; display:inline-block; padding:10px 14px; border:1px solid #0c66d4; border-radius:6px; text-decoration:none; color:#0c66d4; font-weight:bold; }
      nav a:hover { background:#0c66d4; color:#fff; }
      /* compact floating theme toggle (icon) */
      #themeToggleBtn {
        width:44px; height:44px; display:flex; align-items:center; justify-content:center;
        position:fixed; top:12px; right:12px; z-index:9999;
        border-radius:999px; border:1px solid rgba(12,102,212,0.12);
        background:#fff; color:#0c66d4; box-shadow:0 2px 6px rgba(0,0,0,0.08); cursor:pointer;
        font-size:18px; line-height:1;
      }
      #themeToggleBtn:hover { transform:scale(1.06); }
      h1 { margin-bottom: 16px; }
      .filters { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; }
      .filters > div { flex: 1 1 160px; min-width: 160px; }
      label { font-size: 12px; display:block; margin-bottom:4px; color:#555; }
      select, input { width:100%; padding:10px; box-sizing:border-box; }
      table { width:100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border-bottom: 1px solid #eee; padding: 8px; text-align:left; vertical-align: top; }
      th { background:#fafafa; }
  .table-wrap { overflow-x:auto; -webkit-overflow-scrolling: touch; }
  @media (max-width:650px){
    body { padding:0; }
    nav { flex-direction:column; align-items:stretch; }
  nav a, nav button { width:100%; margin:0 0 8px 0; border-radius:10px; min-height:clamp(56px,10vh,72px); font-size:clamp(16px, 2.8vw + 12px, 20px); padding:clamp(14px,2vh,18px) 18px; }
    nav a { margin-right:0; }
    .filters { display:block; padding:12px 16px; }
    .filters > div { min-width:100%; margin-bottom:14px; }
    label { font-size:14px; }
    input, select { font-size:18px; padding:14px 12px; }
    table { font-size:14px; }
  }
      .empty { padding:24px; text-align:center; color:#777; }
      @media (prefers-color-scheme: dark) {
        body { background:#111; color:#eaeaea; }
        label { color:#bbb; }
        th, td { border-bottom:1px solid #333; }
        th { background:#1a1a1a; }
        select, input { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
        .empty { color:#aaa; }
      }
      body.theme-dark { background:#111; color:#eaeaea; }
      body.theme-dark label { color:#bbb; }
      body.theme-dark th, body.theme-dark td { border-bottom:1px solid #333; }
      body.theme-dark th { background:#1a1a1a; }
      body.theme-dark select, body.theme-dark input { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
      body.theme-dark .empty { color:#aaa; }
  body.theme-dark #themeToggleBtn { background:#1a1a1a; color:#ffd580; border-color:#3769e6; box-shadow:none; }
  body.theme-dark #themeToggleBtn:hover { transform:scale(1.06); }
  body.theme-dark nav a { color:#8ab4ff; border-color:#3769e6; }
  body.theme-dark nav a:hover { background:#1f3a75; color:#eaeaea; }
      body.theme-light { background:#fff; color:#111; }
    </style>
    <script>
      // å…¥åŠ›ã®å‘¼ã³å‡ºã—ã‚’é–“å¼•ãç°¡æ˜“ãƒ‡ãƒã‚¦ãƒ³ã‚¹
      let __kwTimer = null;
      function updateResultsDebounced(){
        if (__kwTimer) clearTimeout(__kwTimer);
        __kwTimer = setTimeout(function(){ updateResults(); }, 250);
      }
      function applyTheme(pref){ document.body.classList.remove('theme-dark','theme-light'); if(pref==='dark')document.body.classList.add('theme-dark'); if(pref==='light')document.body.classList.add('theme-light'); }
      function updateThemeButton(pref){
        const b = document.getElementById('themeToggleBtn');
        if(!b) return;
        if(pref === 'dark'){ b.innerHTML = 'ğŸŒ™'; b.title = 'ãƒ†ãƒ¼ãƒ: ãƒ€ãƒ¼ã‚¯'; b.setAttribute('aria-label','ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰'); }
        else if(pref === 'light'){ b.innerHTML = 'â˜€ï¸'; b.title = 'ãƒ†ãƒ¼ãƒ: ãƒ©ã‚¤ãƒˆ'; b.setAttribute('aria-label','ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰'); }
        else { b.innerHTML = 'ğŸŒ“'; b.title = 'ãƒ†ãƒ¼ãƒ: è‡ªå‹•'; b.setAttribute('aria-label','ãƒ†ãƒ¼ãƒ: è‡ªå‹•'); }
      }
      function initTheme(){ const p=localStorage.getItem('theme')||'system'; applyTheme(p); updateThemeButton(p); }
      function toggleTheme(){ const cur=localStorage.getItem('theme')||'system'; const next=cur==='system'?'dark':(cur==='dark'?'light':'system'); localStorage.setItem('theme',next); applyTheme(next); updateThemeButton(next); }
      window.addEventListener('load', initTheme);
    </script>
    <script>
      function escapeHtml(s){return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
      function runMergeFacilities(){
        if (!confirm('ã€æ³¨æ„ã€‘Facilities ã‚’åŒä¸€ä½æ‰€ã§çµ±åˆï¼ˆç ´å£Šçš„ï¼‰ã—ã¾ã™ã€‚ç›´å‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚·ãƒ¼ãƒˆã‚’è‡ªå‹•ä½œæˆã—ã¾ã™ã€‚å®Ÿè¡Œã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
        google.script.run.withSuccessHandler(function(res){
          alert('çµ±åˆå®Œäº†\nãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: '+(res && res.backupSheet)+'\nã‚°ãƒ«ãƒ¼ãƒ—æ•°: '+(res && res.mergedGroups)+'\næ›´æ–°è¡Œ: '+(res && res.updatedRows)+'\nå‰Šé™¤è¡Œ: '+(res && res.deletedRows));
          updateResults();
        }).runMergeFacilitiesByAddress();
      }
      // ç°¡æ˜“ç®¡ç†è€…åˆ¤å®šï¼ˆãƒ¡ãƒ¼ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³ç­‰ã§æ¡ä»¶ã‚’å¾Œã‹ã‚‰æ‹¡å¼µå¯èƒ½ï¼‰
      function showAdminBoxIfAllowed(){
        // æ¡ä»¶: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã« adminMerge=1 ãŒã‚ã‚‹æ™‚ã®ã¿è¡¨ç¤ºï¼ˆä»®é‹ç”¨ï¼‰
        try {
          if (localStorage.getItem('adminMerge') === '1') {
            const box = document.getElementById('adminMergeBox'); if (box) box.style.display='block';
          }
        } catch(e){}
      }

      function onPrefChange(){
        const pref = document.getElementById('prefSelect').value;
        const munSel = document.getElementById('munSelect');
        munSel.innerHTML = '<option value="">å¸‚åŒºç”ºæ‘èª­è¾¼ä¸­...</option>';
        if (!pref){ munSel.innerHTML = '<option value="">-- å…ˆã«éƒ½é“åºœçœŒ --</option>'; updateResults(); return; }
        google.script.run.withSuccessHandler(function(list){
          munSel.innerHTML = '<option value="">å…¨ã¦</option>';
          list.forEach(function(m){
            const opt = document.createElement('option');
            opt.value = m.municipality; opt.textContent = m.municipality;
            munSel.appendChild(opt);
          });
          updateResults();
        }).getMunicipalities({ prefecture: pref });
      }

      function updateResults(){
        const params = {
          prefecture: document.getElementById('prefSelect').value || '',
          municipality: document.getElementById('munSelect').value || '',
          facilityType: document.getElementById('typeSelect').value || '',
          q: document.getElementById('kwInput').value || '',
          limit: 400 // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºä¿ã®ãŸã‚ä¸Šé™
        };
        // ç©ºå€¤ã‚’å‰Šé™¤
        Object.keys(params).forEach(k => { if (!params[k]) delete params[k]; });
        const tbody = document.getElementById('resultRows');
        tbody.innerHTML = '<tr><td colspan="6">æ¤œç´¢ä¸­...</td></tr>';
        const mode = document.getElementById('groupToggle') ? document.getElementById('groupToggle').value : 'normal';
        const handler = function(list){
          if (!list || !list.length){ tbody.innerHTML = '<tr><td colspan="6" class="empty">è©²å½“ã™ã‚‹å–¶æ¥­å…ˆãŒã‚ã‚Šã¾ã›ã‚“</td></tr>'; return; }
          let html='';
          list.forEach(function(f){
            html += '<tr>'
              + '<td>'+escapeHtml(f.name)+'</td>'
              + '<td>'+escapeHtml(f.prefecture||'')+'</td>'
              + '<td>'+escapeHtml(f.municipality||'')+'</td>'
              + '<td>'+escapeHtml(f.facilityType||'')+'</td>'
              + '<td>'+escapeHtml(f.address||'')+'</td>'
              + '<td>'+(f.phone?escapeHtml(f.phone):'')+'</td>'
              + '</tr>';
          });
          tbody.innerHTML = html;
        };
        if (mode === 'grouped') {
          google.script.run.withSuccessHandler(handler).searchFacilitiesGrouped(params);
        } else {
          google.script.run.withSuccessHandler(handler).searchFacilities(params);
        }
      }

      window.addEventListener('load', function(){
        showAdminBoxIfAllowed();
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéƒ½é“åºœçœŒã‚’æ ƒæœ¨çœŒã«è¨­å®š
        try {
          const sel = document.getElementById('prefSelect');
          if (sel && !sel.value) { sel.value = 'æ ƒæœ¨çœŒ'; onPrefChange(); }
        } catch(e){}
        updateResults();
      });
    </script>
  </head>
  <body>
    <nav>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=index">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=facilities">æ–½è¨­ç™»éŒ²</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=manage">æ–½è¨­ãƒ»æ‹…å½“è€…ç®¡ç†</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=visits">å•ã„åˆã‚ã›è¨˜éŒ²</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=reports">å–¶æ¥­å ±å‘Š</a>
  <button id="themeToggleBtn" type="button" onclick="toggleTheme()" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ“</button>
    </nav>
    <h1>å–¶æ¥­å…ˆæ¤œç´¢</h1>
    <div id="adminMergeBox" style="display:none; margin:8px 0; padding:10px; border:1px solid #f0ad4e; border-radius:6px; background:#fff8e1;">
      <b>ãƒ‡ãƒ¼ã‚¿çµ±åˆä½œæ¥­ï¼ˆé–‹ç™ºè€…å‘ã‘ï¼‰</b>
      <div style="margin-top:6px;">
        <button onclick="runMergeFacilities()">ä½æ‰€çµ±åˆãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œï¼ˆç ´å£Šçš„ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚ã‚Šï¼‰</button>
        <span style="font-size:12px; color:#8a6d3b; margin-left:6px;">ä½æ‰€å®Œå…¨ä¸€è‡´ã§åŒä¸€æ‹ ç‚¹ã‚’1è¡Œã«ã¾ã¨ã‚ã¾ã™</span>
      </div>
    </div>
    <div class="filters">
      <div>
        <label for="prefSelect">éƒ½é“åºœçœŒ</label>
        <select id="prefSelect" onchange="onPrefChange()">
          <option value="">å…¨ã¦</option>
          <option>æ±äº¬éƒ½</option><option>ç¥å¥ˆå·çœŒ</option><option>åƒè‘‰çœŒ</option><option>åŸ¼ç‰çœŒ</option><option>èŒ¨åŸçœŒ</option><option selected>æ ƒæœ¨çœŒ</option><option>ç¾¤é¦¬çœŒ</option><option>å±±æ¢¨çœŒ</option>
        </select>
      </div>
      <div>
        <label for="munSelect">å¸‚åŒºç”ºæ‘</label>
        <select id="munSelect" onchange="updateResults()">
          <option value="">å…¨ã¦</option>
        </select>
      </div>
      <div>
        <label for="typeSelect">äº‹æ¥­æ‰€ç¨®é¡</label>
        <select id="typeSelect" onchange="updateResults()">
          <option value="">å…¨ã¦</option>
          <optgroup label="é«˜é½¢è€…ç³»">
            <option value="å±…å®…ä»‹è­·æ”¯æ´">å±…å®…ä»‹è­·æ”¯æ´</option>
            <option value="è¨ªå•ä»‹è­·">è¨ªå•ä»‹è­·</option>
            <option value="é€šæ‰€ä»‹è­·">é€šæ‰€ä»‹è­·</option>
            <option value="è¨ªå•çœ‹è­·">è¨ªå•çœ‹è­·</option>
            <option value="çœ‹è­·å°è¦æ¨¡å¤šæ©Ÿèƒ½">çœ‹è­·å°è¦æ¨¡å¤šæ©Ÿèƒ½</option>
            <option value="ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ">ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ </option>
            <option value="æœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ">æœ‰æ–™è€äººãƒ›ãƒ¼ãƒ </option>
            <option value="ã‚µãƒ¼ãƒ“ã‚¹ä»˜é«˜é½¢è€…ä½å®…">ã‚µãƒ¼ãƒ“ã‚¹ä»˜é«˜é½¢è€…ä½å®…</option>
          </optgroup>
          <optgroup label="éšœå®³ç¦ç¥‰ï¼ˆæˆäººï¼‰">
            <option value="å°±åŠ´ç§»è¡Œæ”¯æ´">å°±åŠ´ç§»è¡Œæ”¯æ´</option>
            <option value="å°±åŠ´ç¶™ç¶šæ”¯æ´Aå‹">å°±åŠ´ç¶™ç¶šæ”¯æ´Aå‹</option>
            <option value="å°±åŠ´ç¶™ç¶šæ”¯æ´Bå‹">å°±åŠ´ç¶™ç¶šæ”¯æ´Bå‹</option>
            <option value="å°±åŠ´å®šç€æ”¯æ´">å°±åŠ´å®šç€æ”¯æ´</option>
            <option value="ç”Ÿæ´»ä»‹è­·">ç”Ÿæ´»ä»‹è­·</option>
            <option value="è‡ªç«‹è¨“ç·´ï¼ˆç”Ÿæ´»è¨“ç·´ï¼‰">è‡ªç«‹è¨“ç·´ï¼ˆç”Ÿæ´»è¨“ç·´ï¼‰</option>
            <option value="è‡ªç«‹è¨“ç·´ï¼ˆæ©Ÿèƒ½è¨“ç·´ï¼‰">è‡ªç«‹è¨“ç·´ï¼ˆæ©Ÿèƒ½è¨“ç·´ï¼‰</option>
            <option value="å…±åŒç”Ÿæ´»æ´åŠ©ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ ï¼‰">å…±åŒç”Ÿæ´»æ´åŠ©ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ ï¼‰</option>
            <option value="çŸ­æœŸå…¥æ‰€ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ï¼‰">çŸ­æœŸå…¥æ‰€ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ï¼‰</option>
            <option value="å±…å®…ä»‹è­·ï¼ˆéšœå®³ï¼‰">å±…å®…ä»‹è­·ï¼ˆéšœå®³ï¼‰</option>
            <option value="é‡åº¦è¨ªå•ä»‹è­·">é‡åº¦è¨ªå•ä»‹è­·</option>
            <option value="åŒè¡Œæ´è­·">åŒè¡Œæ´è­·</option>
            <option value="è¡Œå‹•æ´è­·">è¡Œå‹•æ´è­·</option>
            <option value="ç§»å‹•æ”¯æ´">ç§»å‹•æ”¯æ´</option>
            <option value="æ–½è¨­å…¥æ‰€æ”¯æ´">æ–½è¨­å…¥æ‰€æ”¯æ´</option>
          </optgroup>
          <optgroup label="ç›¸è«‡æ”¯æ´">
            <option value="ç‰¹å®šç›¸è«‡æ”¯æ´ï¼ˆè¨ˆç”»ç›¸è«‡ï¼‰">ç‰¹å®šç›¸è«‡æ”¯æ´ï¼ˆè¨ˆç”»ç›¸è«‡ï¼‰</option>
            <option value="éšœå®³å…ç›¸è«‡æ”¯æ´">éšœå®³å…ç›¸è«‡æ”¯æ´</option>
          </optgroup>
          <optgroup label="å…ç«¥ãƒ»ç™‚è‚²">
            <option value="å…ç«¥ç™ºé”æ”¯æ´">å…ç«¥ç™ºé”æ”¯æ´</option>
            <option value="æ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹">æ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹</option>
            <option value="ä¿è‚²æ‰€ç­‰è¨ªå•æ”¯æ´">ä¿è‚²æ‰€ç­‰è¨ªå•æ”¯æ´</option>
            <option value="å…ç«¥ç™ºé”æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼">å…ç«¥ç™ºé”æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼</option>
          </optgroup>
          <optgroup label="ãã®ä»–ãƒ»é–¢é€£æ©Ÿé–¢">
            <option value="ã‚±ã‚¢ãƒãƒ">ã‚±ã‚¢ãƒãƒ</option>
            <option value="åŒ»ç™‚æ©Ÿé–¢">åŒ»ç™‚æ©Ÿé–¢</option>
            <option value="å¸‚å½¹æ‰€">å¸‚å½¹æ‰€</option>
            <option value="è¡Œæ”¿æ©Ÿé–¢">è¡Œæ”¿æ©Ÿé–¢</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </optgroup>
        </select>
      </div>
      <div>
        <label for="kwInput">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
        <input id="kwInput" type="text" placeholder="åç§°/ä½æ‰€/å‚™è€ƒãªã©" oninput="updateResultsDebounced()">
      </div>
      <div>
        <label for="groupToggle">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</label>
        <select id="groupToggle" onchange="updateResults()">
          <option value="normal">äº‹æ¥­æ‰€å˜ä½</option>
          <option value="grouped">ä½æ‰€çµ±åˆ</option>
        </select>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th id="thName">æ–½è¨­å / æ‹ ç‚¹</th><th>éƒ½é“åºœçœŒ</th><th>å¸‚åŒºç”ºæ‘</th><th id="thType">ç¨®é¡</th><th>ä½æ‰€</th><th>é›»è©±</th></tr>
        </thead>
        <tbody id="resultRows"><tr><td colspan="6">èª­ã¿è¾¼ã¿ä¸­...</td></tr></tbody>
      </table>
    </div>
  </body>
</html>
