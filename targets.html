<!DOCTYPE html>
<html>
  <head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
      body { font-family: Arial, sans-serif; padding: 24px; }
      nav { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
      nav a { margin-right: 12px; display:inline-block; padding:10px 14px; border:1px solid #0c66d4; border-radius:6px; text-decoration:none; color:#0c66d4; font-weight:bold; }
      nav a:hover { background:#0c66d4; color:#fff; }
      #themeToggleBtn { padding:10px 14px; border:1px solid #0c66d4; background:#fff; color:#0c66d4; border-radius:6px; font-weight:bold; cursor:pointer; }
      #themeToggleBtn:hover { background:#0c66d4; color:#fff; }
      nav #themeToggleBtn { margin-left:auto; }
      h1 { margin-bottom: 16px; }
      .filters { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; }
      .filters > div { flex: 1 1 160px; min-width: 160px; }
      label { font-size: 12px; display:block; margin-bottom:4px; color:#555; }
      select, input { width:100%; padding:10px; box-sizing:border-box; }
      table { width:100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border-bottom: 1px solid #eee; padding: 8px; text-align:left; vertical-align: top; }
      th { background:#fafafa; }
      .table-wrap { overflow-x:auto; }
  @media (max-width:650px){
    body { padding:0; }
    nav { flex-direction:column; align-items:stretch; }
    nav a, nav button { width:100%; margin:0 0 8px 0; font-size:16px; padding:16px 18px; min-height:56px; border-radius:0; }
    nav a { margin-right:0; }
    #themeToggleBtn { width:100%; }
    .filters { display:block; padding:12px 16px; }
    .filters > div { min-width:100%; margin-bottom:14px; }
    label { font-size:14px; }
    input, select { font-size:16px; padding:14px 12px; }
    table { font-size:14px; }
  }
      .empty { padding:24px; text-align:center; color:#777; }
      @media (prefers-color-scheme: dark) {
        body { background:#111; color:#eaeaea; }
        label { color:#bbb; }
        th, td { border-bottom:1px solid #333; }
        th { background:#1a1a1a; }
        select, input { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
        .empty { color:#aaa; }
      }
      body.theme-dark { background:#111; color:#eaeaea; }
      body.theme-dark label { color:#bbb; }
      body.theme-dark th, body.theme-dark td { border-bottom:1px solid #333; }
      body.theme-dark th { background:#1a1a1a; }
      body.theme-dark select, body.theme-dark input { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
      body.theme-dark .empty { color:#aaa; }
  body.theme-dark #themeToggleBtn { background:#1a1a1a; color:#8ab4ff; border-color:#3769e6; }
  body.theme-dark #themeToggleBtn:hover { background:#1f3a75; color:#eaeaea; }
  body.theme-dark nav a { color:#8ab4ff; border-color:#3769e6; }
  body.theme-dark nav a:hover { background:#1f3a75; color:#eaeaea; }
      body.theme-light { background:#fff; color:#111; }
    </style>
    <script>
      // 入力の呼び出しを間引く簡易デバウンス
      let __kwTimer = null;
      function updateResultsDebounced(){
        if (__kwTimer) clearTimeout(__kwTimer);
        __kwTimer = setTimeout(function(){ updateResults(); }, 250);
      }
      function applyTheme(pref){ document.body.classList.remove('theme-dark','theme-light'); if(pref==='dark')document.body.classList.add('theme-dark'); if(pref==='light')document.body.classList.add('theme-light'); }
      function updateThemeButton(pref){ const b=document.getElementById('themeToggleBtn'); if(b) b.textContent = pref==='dark'?'テーマ: ダーク':(pref==='light'?'テーマ: ライト':'テーマ: 自動'); }
      function initTheme(){ const p=localStorage.getItem('theme')||'system'; applyTheme(p); updateThemeButton(p); }
      function toggleTheme(){ const cur=localStorage.getItem('theme')||'system'; const next=cur==='system'?'dark':(cur==='dark'?'light':'system'); localStorage.setItem('theme',next); applyTheme(next); updateThemeButton(next); }
      window.addEventListener('load', initTheme);
    </script>
    <script>
      function escapeHtml(s){return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
      function runMergeFacilities(){
        if (!confirm('【注意】Facilities を同一住所で統合（破壊的）します。直前にバックアップシートを自動作成します。実行してよろしいですか？')) return;
        google.script.run.withSuccessHandler(function(res){
          alert('統合完了\nバックアップ: '+(res && res.backupSheet)+'\nグループ数: '+(res && res.mergedGroups)+'\n更新行: '+(res && res.updatedRows)+'\n削除行: '+(res && res.deletedRows));
          updateResults();
        }).runMergeFacilitiesByAddress();
      }
      // 簡易管理者判定（メールドメイン等で条件を後から拡張可能）
      function showAdminBoxIfAllowed(){
        // 条件: ローカルストレージに adminMerge=1 がある時のみ表示（仮運用）
        try {
          if (localStorage.getItem('adminMerge') === '1') {
            const box = document.getElementById('adminMergeBox'); if (box) box.style.display='block';
          }
        } catch(e){}
      }

      function onPrefChange(){
        const pref = document.getElementById('prefSelect').value;
        const munSel = document.getElementById('munSelect');
        munSel.innerHTML = '<option value="">市区町村読込中...</option>';
        if (!pref){ munSel.innerHTML = '<option value="">-- 先に都道府県 --</option>'; updateResults(); return; }
        google.script.run.withSuccessHandler(function(list){
          munSel.innerHTML = '<option value="">全て</option>';
          list.forEach(function(m){
            const opt = document.createElement('option');
            opt.value = m.municipality; opt.textContent = m.municipality;
            munSel.appendChild(opt);
          });
          updateResults();
        }).getMunicipalities({ prefecture: pref });
      }

      function updateResults(){
        const params = {
          prefecture: document.getElementById('prefSelect').value || '',
          municipality: document.getElementById('munSelect').value || '',
          facilityType: document.getElementById('typeSelect').value || '',
          q: document.getElementById('kwInput').value || '',
          limit: 400 // パフォーマンス確保のため上限
        };
        // 空値を削除
        Object.keys(params).forEach(k => { if (!params[k]) delete params[k]; });
        const tbody = document.getElementById('resultRows');
        tbody.innerHTML = '<tr><td colspan="6">検索中...</td></tr>';
        const mode = document.getElementById('groupToggle') ? document.getElementById('groupToggle').value : 'normal';
        const handler = function(list){
          if (!list || !list.length){ tbody.innerHTML = '<tr><td colspan="6" class="empty">該当する営業先がありません</td></tr>'; return; }
          let html='';
          list.forEach(function(f){
            html += '<tr>'
              + '<td>'+escapeHtml(f.name)+'</td>'
              + '<td>'+escapeHtml(f.prefecture||'')+'</td>'
              + '<td>'+escapeHtml(f.municipality||'')+'</td>'
              + '<td>'+escapeHtml(f.facilityType||'')+'</td>'
              + '<td>'+escapeHtml(f.address||'')+'</td>'
              + '<td>'+(f.phone?escapeHtml(f.phone):'')+'</td>'
              + '</tr>';
          });
          tbody.innerHTML = html;
        };
        if (mode === 'grouped') {
          google.script.run.withSuccessHandler(handler).searchFacilitiesGrouped(params);
        } else {
          google.script.run.withSuccessHandler(handler).searchFacilities(params);
        }
      }

      window.addEventListener('load', function(){
        showAdminBoxIfAllowed();
        // デフォルト都道府県を栃木県に設定
        try {
          const sel = document.getElementById('prefSelect');
          if (sel && !sel.value) { sel.value = '栃木県'; onPrefChange(); }
        } catch(e){}
        updateResults();
      });
    </script>
  </head>
  <body>
    <nav>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=index">メニュー</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=facilities">施設登録</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=manage">施設・担当者管理</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=visits">問い合わせ記録</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=reports">営業報告</a>
      <button id="themeToggleBtn" type="button" onclick="toggleTheme()">テーマ: 自動</button>
    </nav>
    <h1>営業先検索</h1>
    <div id="adminMergeBox" style="display:none; margin:8px 0; padding:10px; border:1px solid #f0ad4e; border-radius:6px; background:#fff8e1;">
      <b>データ統合作業（開発者向け）</b>
      <div style="margin-top:6px;">
        <button onclick="runMergeFacilities()">住所統合マージを実行（破壊的・バックアップ作成あり）</button>
        <span style="font-size:12px; color:#8a6d3b; margin-left:6px;">住所完全一致で同一拠点を1行にまとめます</span>
      </div>
    </div>
    <div class="filters">
      <div>
        <label for="prefSelect">都道府県</label>
        <select id="prefSelect" onchange="onPrefChange()">
          <option value="">全て</option>
          <option>東京都</option><option>神奈川県</option><option>千葉県</option><option>埼玉県</option><option>茨城県</option><option selected>栃木県</option><option>群馬県</option><option>山梨県</option>
        </select>
      </div>
      <div>
        <label for="munSelect">市区町村</label>
        <select id="munSelect" onchange="updateResults()">
          <option value="">全て</option>
        </select>
      </div>
      <div>
        <label for="typeSelect">事業所種類</label>
        <select id="typeSelect" onchange="updateResults()">
          <option value="">全て</option>
          <optgroup label="高齢者系">
            <option value="居宅介護支援">居宅介護支援</option>
            <option value="訪問介護">訪問介護</option>
            <option value="通所介護">通所介護</option>
            <option value="訪問看護">訪問看護</option>
            <option value="看護小規模多機能">看護小規模多機能</option>
            <option value="特別養護老人ホーム">特別養護老人ホーム</option>
            <option value="有料老人ホーム">有料老人ホーム</option>
            <option value="サービス付高齢者住宅">サービス付高齢者住宅</option>
          </optgroup>
          <optgroup label="障害福祉（成人）">
            <option value="就労移行支援">就労移行支援</option>
            <option value="就労継続支援A型">就労継続支援A型</option>
            <option value="就労継続支援B型">就労継続支援B型</option>
            <option value="就労定着支援">就労定着支援</option>
            <option value="生活介護">生活介護</option>
            <option value="自立訓練（生活訓練）">自立訓練（生活訓練）</option>
            <option value="自立訓練（機能訓練）">自立訓練（機能訓練）</option>
            <option value="共同生活援助（グループホーム）">共同生活援助（グループホーム）</option>
            <option value="短期入所（ショートステイ）">短期入所（ショートステイ）</option>
            <option value="居宅介護（障害）">居宅介護（障害）</option>
            <option value="重度訪問介護">重度訪問介護</option>
            <option value="同行援護">同行援護</option>
            <option value="行動援護">行動援護</option>
            <option value="移動支援">移動支援</option>
            <option value="施設入所支援">施設入所支援</option>
          </optgroup>
          <optgroup label="相談支援">
            <option value="特定相談支援（計画相談）">特定相談支援（計画相談）</option>
            <option value="障害児相談支援">障害児相談支援</option>
          </optgroup>
          <optgroup label="児童・療育">
            <option value="児童発達支援">児童発達支援</option>
            <option value="放課後等デイサービス">放課後等デイサービス</option>
            <option value="保育所等訪問支援">保育所等訪問支援</option>
            <option value="児童発達支援センター">児童発達支援センター</option>
          </optgroup>
          <optgroup label="その他・関連機関">
            <option value="ケアマネ">ケアマネ</option>
            <option value="医療機関">医療機関</option>
            <option value="市役所">市役所</option>
            <option value="行政機関">行政機関</option>
            <option value="その他">その他</option>
          </optgroup>
        </select>
      </div>
      <div>
        <label for="kwInput">キーワード</label>
        <input id="kwInput" type="text" placeholder="名称/住所/備考など" oninput="updateResultsDebounced()">
      </div>
      <div>
        <label for="groupToggle">表示モード</label>
        <select id="groupToggle" onchange="updateResults()">
          <option value="normal">事業所単位</option>
          <option value="grouped">住所統合</option>
        </select>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th id="thName">施設名 / 拠点</th><th>都道府県</th><th>市区町村</th><th id="thType">種類</th><th>住所</th><th>電話</th></tr>
        </thead>
        <tbody id="resultRows"><tr><td colspan="6">読み込み中...</td></tr></tbody>
      </table>
    </div>
  </body>
</html>
