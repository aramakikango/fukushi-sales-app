<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      :root { color-scheme: light dark; }
      *, *::before, *::after { box-sizing: border-box; }
      html, body { width:100%; max-width:100%; overflow-x:hidden; }
  body { font-family: Arial, sans-serif; padding: 24px; margin: 0; }
      nav { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
      nav a { margin-right: 12px; display:inline-block; padding:6px 8px; }
      /* compact floating theme toggle (icon) */
      #themeToggleBtn {
        width:44px; height:44px; display:flex; align-items:center; justify-content:center;
        position:fixed; top:12px; right:12px; z-index:9999;
        border-radius:999px; border:1px solid rgba(12,102,212,0.12);
        background:#fff; color:#0c66d4; box-shadow:0 2px 6px rgba(0,0,0,0.08); cursor:pointer;
        font-size:18px; line-height:1;
      }
      #themeToggleBtn:hover { transform:scale(1.06); }
      label { display:block; margin-top:12px; }
      input, select, textarea { width:100%; padding:8px; box-sizing:border-box; }
      button { margin-top: 12px; padding:8px 14px; }
  .table-wrap { width:100%; overflow-x:auto; -webkit-overflow-scrolling: touch; }
      table { width:100%; border-collapse: collapse; margin-top: 16px; min-width: 760px; }
      th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; }
      .muted { color:#666; font-size:12px; }
  .row { display:grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr); gap: 12px; }
  @media (max-width: 720px) { .row { grid-template-columns: 1fr; } body { padding: 16px; } input, select, textarea { font-size:18px; } button { padding:12px 16px; min-height:clamp(48px,8vh,64px); font-size:clamp(16px,2.8vw + 12px,20px); width:100%; border-radius:10px; } }
      /* Mobile: stack nav vertically and make full-width buttons */
      @media (max-width: 650px) {
        nav { flex-direction: column; align-items: stretch; }
        nav a, nav button { width: 100%; margin: 0 0 8px 0; border-radius: 10px; min-height: clamp(56px,10vh,72px); font-size: clamp(16px, 2.8vw + 12px, 20px); padding: clamp(14px,2vh,18px) 18px; }
  nav a { margin-right: 0; }
      }
      /* Dark mode */
      @media (prefers-color-scheme: dark) {
        body { background:#111; color:#eaeaea; }
        a { color:#8ab4ff; }
        th, td { border-bottom:1px solid #333; }
        input, select, textarea { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
        button { background:#2a2a2a; color:#eaeaea; border:1px solid #444; }
      }
      /* Manual theme overrides (placed after media query to win specificity) */
      body.theme-dark { background:#111; color:#eaeaea; }
      body.theme-dark th, body.theme-dark td { border-bottom:1px solid #333; }
      body.theme-dark input, body.theme-dark select, body.theme-dark textarea { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
      body.theme-dark button { background:#2a2a2a; color:#eaeaea; border:1px solid #444; }
      body.theme-light { background:#fff; color:#111; }
      body.theme-light th, body.theme-light td { border-bottom:1px solid #eee; }
      body.theme-light input, body.theme-light select, body.theme-light textarea { background:#fff; color:#111; border:1px solid #ccc; }
      body.theme-light button { background:#f5f5f5; color:#111; border:1px solid #ccc; }
      body.theme-dark #themeToggleBtn { background:#1a1a1a; color:#8ab4ff; border-color:#3769e6; }
      body.theme-dark #themeToggleBtn:hover { background:#1f3a75; color:#eaeaea; }
    </style>
    <script>
      // Theme toggle with persistence
      function applyTheme(pref){
        document.body.classList.remove('theme-dark','theme-light');
        if (pref === 'dark') document.body.classList.add('theme-dark');
        if (pref === 'light') document.body.classList.add('theme-light');
      }
      function updateThemeButton(pref){
        const btn = document.getElementById('themeToggleBtn'); if(!btn) return;
        if(pref === 'dark'){ btn.innerHTML = 'ğŸŒ™'; btn.title = 'ãƒ†ãƒ¼ãƒ: ãƒ€ãƒ¼ã‚¯'; btn.setAttribute('aria-label','ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰'); }
        else if(pref === 'light'){ btn.innerHTML = 'â˜€ï¸'; btn.title = 'ãƒ†ãƒ¼ãƒ: ãƒ©ã‚¤ãƒˆ'; btn.setAttribute('aria-label','ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰'); }
        else { btn.innerHTML = 'ğŸŒ“'; btn.title = 'ãƒ†ãƒ¼ãƒ: è‡ªå‹•'; btn.setAttribute('aria-label','ãƒ†ãƒ¼ãƒ: è‡ªå‹•'); }
      }
      function initTheme(){
        const pref = localStorage.getItem('theme') || 'system';
        applyTheme(pref);
        updateThemeButton(pref);
      }
      function toggleTheme(){
        const current = localStorage.getItem('theme') || 'system';
        const next = current === 'system' ? 'dark' : current === 'dark' ? 'light' : 'system';
        localStorage.setItem('theme', next);
        applyTheme(next);
        updateThemeButton(next);
      }

      // Facility handling
      let CURRENT_FACILITY_ID = '';
      function escapeHtml(str){ if(!str) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function escapeJs(str){ if (str == null) return ''; return String(str).replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }
      function formatDateForDisplay(value) {
        if (!value) return '';
        const date = new Date(value);
        if (isNaN(date.getTime())) return escapeHtml(value);
        return date.toLocaleDateString();
      }
      function nowForDatetimeLocal(){
        const d = new Date();
        const p = n=> String(n).padStart(2,'0');
        return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
      }
      function getVisitSubmitButton(){
        return document.getElementById('visitSubmitBtn') || (document.getElementById('visitForm') ? document.getElementById('visitForm').querySelector('button[type="submit"]') : null);
      }
      function setVisitSubmitDisabled(disabled){
        const btn = getVisitSubmitButton();
        if (btn) btn.disabled = !!disabled;
      }
      let isSubmittingVisit = false;
      function normalizeMultiSelectionValue(value){
        if (!value) return [];
        return String(value).split(/[ã€,\/]+/).map(s=>s.trim()).filter(Boolean);
      }
      function getMultiSelectValue(id){
        const select = document.getElementById(id);
        if (!select) return '';
        if (!select.multiple) return select.value || '';
        const values = Array.from(select.selectedOptions).map(o=> String(o.value || o.text || '').trim()).filter(Boolean);
        return values.join('ã€');
      }
      function setMultiSelectValue(id, raw){
        const select = document.getElementById(id);
        if (!select) return;
        const targets = new Set(normalizeMultiSelectionValue(raw));
        if (!select.multiple) {
          select.value = raw || '';
          return;
        }
        Array.from(select.options).forEach(function(opt){
          opt.selected = targets.has(String(opt.value));
        });
      }
      function beginSubmitAttempt(){
        isSubmittingVisit = true;
        setVisitSubmitDisabled(true);
      }
      function finishSubmitAttempt(){
        isSubmittingVisit = false;
        const fid = CURRENT_FACILITY_ID || (document.getElementById('visitFacility')||{}).value;
        setVisitSubmitDisabled(!fid);
      }
      function handleSubmitFailure(error){
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error && error.message ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        finishSubmitAttempt();
      }
      function getFacilityFilterParams(){
        const params = { limit: 600 };
        const prefSel = document.getElementById('facilityPref');
        const munSel = document.getElementById('facilityMun');
        if (prefSel && prefSel.value) params.prefecture = prefSel.value;
        if (munSel && munSel.value) params.municipality = munSel.value;
        return params;
      }
      function loadFacilities(){
        const wrap = document.getElementById('facilityWrap');
        const sel = document.getElementById('visitFacility');
        if (!sel) return;
        sel.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';
        sel.disabled = true;
        const params = getFacilityFilterParams();
        google.script.run.withSuccessHandler(function(list){
          const facilities = Array.isArray(list) ? list : [];
            if (!facilities.length) {
            if (wrap) wrap.style.display = 'block';
            sel.innerHTML = '<option value="">è©²å½“ã™ã‚‹æ–½è¨­ãŒã‚ã‚Šã¾ã›ã‚“</option>';
            setVisitSubmitDisabled(true);
            CURRENT_FACILITY_ID = '';
            document.getElementById('activityBox').innerHTML = '';
            document.getElementById('visitRows').innerHTML = '<tr><td colspan="8">æ–½è¨­ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
            return;
          }
          if (facilities.length === 1) {
            if (wrap) wrap.style.display = 'none';
            CURRENT_FACILITY_ID = facilities[0].id;
            setVisitSubmitDisabled(false);
            onFacilityChangeInternal(CURRENT_FACILITY_ID);
            return;
          }
          if (wrap) wrap.style.display = 'block';
          sel.disabled = false;
          sel.innerHTML = '<option value="">-- æ–½è¨­ã‚’é¸æŠ --</option>';
          facilities.forEach(function(f){
            const o = document.createElement('option');
            o.value = f.id;
            o.textContent = f.name + (f.municipality ? 'ï¼ˆ' + f.municipality + 'ï¼‰' : '');
            sel.appendChild(o);
          });
          if (CURRENT_FACILITY_ID) {
            sel.value = CURRENT_FACILITY_ID;
            if (sel.value === CURRENT_FACILITY_ID) {
              setVisitSubmitDisabled(false);
              onFacilityChangeInternal(CURRENT_FACILITY_ID);
              return;
            }
          }
          CURRENT_FACILITY_ID = '';
          setVisitSubmitDisabled(true);
          document.getElementById('activityBox').innerHTML = '';
          document.getElementById('visitRows').innerHTML = '<tr><td colspan="8">æ–½è¨­ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>';
        }).searchFacilities(params);
      }
      function onFacilityPrefChange(){
        CURRENT_FACILITY_ID = '';
        const prefSel = document.getElementById('facilityPref');
        const munSel = document.getElementById('facilityMun');
        if (!munSel) { loadFacilities(); return; }
        munSel.innerHTML = '<option value="">å¸‚åŒºç”ºæ‘ï¼ˆå…¨ã¦ï¼‰</option>';
        munSel.disabled = true;
        const pref = prefSel ? prefSel.value : '';
        if (!pref) {
          munSel.disabled = false;
          loadFacilities();
          return;
        }
        google.script.run.withSuccessHandler(function(list){
          munSel.disabled = false;
          munSel.innerHTML = '<option value="">å¸‚åŒºç”ºæ‘ï¼ˆå…¨ã¦ï¼‰</option>';
          (list || []).forEach(function(item){
            const opt = document.createElement('option');
            opt.value = item.municipality;
            opt.textContent = item.municipality;
            munSel.appendChild(opt);
          });
          loadFacilities();
        }).getMunicipalities({ prefecture: pref });
      }
      function initFacilityFilters(){
        const prefSel = document.getElementById('facilityPref');
        const munSel = document.getElementById('facilityMun');
        if (prefSel) {
          prefSel.addEventListener('change', onFacilityPrefChange);
        }
        if (munSel) {
          munSel.addEventListener('change', function(){
            CURRENT_FACILITY_ID = '';
            loadFacilities();
          });
        }
        onFacilityPrefChange();
      }
      function onFacilityChange(){
        const fid = document.getElementById('visitFacility').value;
        CURRENT_FACILITY_ID = fid || '';
        setVisitSubmitDisabled(!fid);
        onFacilityChangeInternal(CURRENT_FACILITY_ID);
      }
      function onFacilityChangeInternal(fid){
        if (!fid) {
          document.getElementById('visitRows').innerHTML = '<tr><td colspan="8">æ–½è¨­ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>';
          document.getElementById('activityBox').innerHTML = '';
          const convBox = document.getElementById('conversionBox'); if (convBox) convBox.textContent = '';
          return;
        }
        google.script.run.withSuccessHandler(function(s){
          const box = document.getElementById('activityBox');
          if (!s) { box.innerHTML = ''; return; }
          const lv = s.lastVisitDate ? new Date(s.lastVisitDate).toLocaleString() : '-';
          const lr = s.lastReportDate ? new Date(s.lastReportDate).toLocaleString() : '-';
          box.innerHTML = 'è¨ªå•/å•ã„åˆã‚ã›å›æ•°: <b>' + (s.visitCount||0) + '</b>ï¼ˆæœ€çµ‚: ' + lv + 'ï¼‰ / å ±å‘Šå›æ•°: <b>' + (s.reportCount||0) + '</b>ï¼ˆæœ€çµ‚: ' + lr + 'ï¼‰';
        }).getFacilityActivitySummary(fid);
        loadConversionSummary(fid);
        loadVisits(fid);
      }
      function loadVisits(fid){
        google.script.run.withSuccessHandler(function(list){
          const tbody = document.getElementById('visitRows');
          if (!list || list.length === 0) { tbody.innerHTML = '<tr><td colspan="8">è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>'; return; }
          let html = '';
          list.forEach(function(v){
            const d = v.visitDate ? new Date(v.visitDate).toLocaleString() : '';
            const wishes = [(v.wantsGroupHome?'GH':''),(v.wantsHomeNursing?'è¨ªçœ‹':'')].filter(Boolean).join(' / ');
            html += '<tr>' +
              '<td>' + escapeHtml(d) + '</td>' +
              '<td>' + escapeHtml(v.inquiryType || '') + '</td>' +
              '<td>' + escapeHtml(v.visitorName || '') + (v.visitorRelation? ('ï¼ˆ' + escapeHtml(v.visitorRelation) + 'ï¼‰') : '') + (v.subjectName ? (' / å¯¾è±¡:' + escapeHtml(v.subjectName)) : '') + '</td>' +
              '<td>' + escapeHtml(v.visitPurpose || '') + '</td>' +
            '<td>' + escapeHtml(v.diagnosis || '') + (v.disabilityCategory? (' / ' + escapeHtml(v.disabilityCategory)) : '') + (wishes? (' / ' + wishes) : '') + '</td>' +
            '<td>' + escapeHtml(v.placementStage || '') + (v.placementStageDate ? ('ï¼ˆ' + escapeHtml(formatDateForDisplay(v.placementStageDate)) + 'ï¼‰') : '') + '</td>' +
            '<td>' + escapeHtml(v.notes || '') + '</td>' +
              '<td><button type="button" onclick="editVisit(\'' + escapeJs(v.id) + '\')">ç·¨é›†</button></td>' +
              '</tr>';
          });
          tbody.innerHTML = html;
        }).getVisits({ facilityId: fid });
      }

      function renderConversionSummary(summary){
        const box = document.getElementById('conversionBox');
        if (!box) return;
        if (!summary) {
          box.innerHTML = 'è¨ªå•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
          return;
        }
        const rate = summary.conversionRate != null ? String(summary.conversionRate) + '%' : '-';
        box.innerHTML = 'å–¶æ¥­: <b>' + summary.total + '</b>ä»¶ / æˆç´„: <b>' + summary.deals + '</b>ä»¶ / ãŠæ–­ã‚Š: <b>' + summary.rejects + '</b>ä»¶ / ãã®ä»–: <b>' + summary.other + '</b>ä»¶ / è»¢æ›ç‡: <b>' + rate + '</b>';
      }

      function loadConversionSummary(fid){
        const box = document.getElementById('conversionBox');
        if (box && !fid) { box.textContent = ''; }
        if (!fid) return;
        google.script.run.withSuccessHandler(function(summary){ renderConversionSummary(summary); }).getConversionSummary({ facilityId: fid });
      }
      
      // æ—¢å­˜ã®è¨˜éŒ²ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«èª­ã¿è¾¼ã‚“ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹
      function editVisit(id){
        if (!id) return alert('ç„¡åŠ¹ãªID');
        google.script.run.withSuccessHandler(function(v){
          if (!v) { alert('ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
          // set facility selector
          const sel = document.getElementById('visitFacility');
          if (sel) { sel.value = v.facilityId || ''; CURRENT_FACILITY_ID = v.facilityId || ''; }
          // populate fields
          document.getElementById('visitId').value = v.id || '';
          document.getElementById('visitDate').value = v.visitDate || '';
          document.getElementById('inquiryType').value = v.inquiryType || '';
          document.getElementById('visitorName').value = v.visitorName || '';
          document.getElementById('visitorRelation').value = v.visitorRelation || '';
          document.getElementById('callerPhone').value = v.callerPhone || '';
          document.getElementById('callerEmail').value = v.callerEmail || '';
          document.getElementById('subjectName').value = v.subjectName || '';
          document.getElementById('subjectAge').value = v.subjectAge || '';
          document.getElementById('subjectGender').value = v.subjectGender || '';
          document.getElementById('diagnosis').value = v.diagnosis || '';
          setMultiSelectValue('disabilityCategory', v.disabilityCategory || '');
          document.getElementById('careLevel').value = v.careLevel || '';
          document.getElementById('residenceMunicipality').value = v.residenceMunicipality || '';
          document.getElementById('wantsGroupHome').checked = (v.wantsGroupHome === '1' || v.wantsGroupHome === true || v.wantsGroupHome === 'true');
          document.getElementById('wantsHomeNursing').checked = (v.wantsHomeNursing === '1' || v.wantsHomeNursing === true || v.wantsHomeNursing === 'true');
          document.getElementById('desiredStartDate').value = v.desiredStartDate || '';
          document.getElementById('visitPurpose').value = v.visitPurpose || '';
          document.getElementById('urgency').value = v.urgency || '';
          document.getElementById('preferredContactMethod').value = v.preferredContactMethod || '';
          document.getElementById('preferredContactTime').value = v.preferredContactTime || '';
          document.getElementById('referralSource').value = v.referralSource || '';
          document.getElementById('consentFlag').checked = (v.consentFlag === true || v.consentFlag === '1' || v.consentFlag === 'true');
          document.getElementById('notes').value = v.notes || '';
          document.getElementById('placementStage').value = v.placementStage || '';
          document.getElementById('placementStageDate').value = v.placementStageDate || '';
          // outcome/rejection
          document.getElementById('outcome').value = v.outcome || '';
          document.getElementById('rejectionStage').value = v.rejectionStage || '';
          document.getElementById('rejectionDate').value = v.rejectionDate || '';
          document.getElementById('rejectionReason').value = v.rejectionReason || '';
          onOutcomeChange();
          // UI: switch submit button to update mode
          const btn = document.getElementById('visitSubmitBtn'); if (btn) btn.textContent = 'æ›´æ–°';
          const cancel = document.getElementById('cancelEditBtn'); if (cancel) cancel.style.display = 'inline-block';
          setVisitSubmitDisabled(false);
        }).getVisit(id);
      }

      function cancelEdit(){
        document.getElementById('visitForm').reset();
        document.getElementById('visitId').value = '';
        document.getElementById('visitDate').value = nowForDatetimeLocal();
        const btn = document.getElementById('visitSubmitBtn'); if (btn) btn.textContent = 'è¨˜éŒ²ã‚’ç™»éŒ²';
        const cancel = document.getElementById('cancelEditBtn'); if (cancel) cancel.style.display = 'none';
        onInquiryTypeChange();
        setVisitSubmitDisabled(true);
      }
      function onInquiryTypeChange(){
        // é›»è©±ã§ã‚‚è©³ç´°ã‚’è¨˜å…¥ã§ãã‚‹ã‚ˆã†å¸¸æ™‚è¡¨ç¤º
        const blk = document.getElementById('visitorFields');
        if (blk) blk.style.display = 'block';
      }

      function onOutcomeChange(){
        const val = (document.getElementById('outcome')||{}).value || '';
        const block = document.getElementById('rejectionBlock');
        if (!block) return;
        if (val === 'ãŠæ–­ã‚Š' || val.indexOf('æ–­') !== -1 || val.indexOf('æ‹’') !== -1) {
          block.style.display = 'block';
        } else {
          block.style.display = 'none';
        }
      }
      function submitVisit(){
        const facilityId = CURRENT_FACILITY_ID || document.getElementById('visitFacility').value;
        if (!facilityId) { alert('æ–½è¨­ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        if (isSubmittingVisit) {
          alert('é€ä¿¡ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
          return;
        }
        beginSubmitAttempt();
        const data = {
          facilityId: facilityId,
          visitDate: document.getElementById('visitDate').value,
          inquiryType: document.getElementById('inquiryType').value,
          visitorName: document.getElementById('visitorName').value,
          visitorRelation: document.getElementById('visitorRelation').value,
          callerPhone: (document.getElementById('callerPhone')||{}).value || '',
          callerEmail: (document.getElementById('callerEmail')||{}).value || '',
          subjectName: (document.getElementById('subjectName')||{}).value || '',
          subjectAge: (document.getElementById('subjectAge')||{}).value || '',
          subjectGender: (document.getElementById('subjectGender')||{}).value || '',
          diagnosis: document.getElementById('diagnosis').value,
          disabilityCategory: getMultiSelectValue('disabilityCategory'),
          careLevel: (document.getElementById('careLevel')||{}).value || '',
          residenceMunicipality: (document.getElementById('residenceMunicipality')||{}).value || '',
          wantsGroupHome: document.getElementById('wantsGroupHome').checked,
          wantsHomeNursing: document.getElementById('wantsHomeNursing').checked,
          desiredStartDate: (document.getElementById('desiredStartDate')||{}).value || '',
          visitPurpose: document.getElementById('visitPurpose').value,
          urgency: (document.getElementById('urgency')||{}).value || '',
          preferredContactMethod: (document.getElementById('preferredContactMethod')||{}).value || '',
          preferredContactTime: (document.getElementById('preferredContactTime')||{}).value || '',
          referralSource: (document.getElementById('referralSource')||{}).value || '',
          consentFlag: (document.getElementById('consentFlag')||{}).checked || false,
          notes: document.getElementById('notes').value
        };
        // outcome / rejection info
        data.outcome = (document.getElementById('outcome')||{}).value || '';
        data.rejectionStage = (document.getElementById('rejectionStage')||{}).value || '';
        data.rejectionDate = (document.getElementById('rejectionDate')||{}).value || '';
        data.rejectionReason = (document.getElementById('rejectionReason')||{}).value || '';
        const visitIdField = document.getElementById('visitId');
        const isEdit = visitIdField && visitIdField.value;
        if (isEdit) data.id = visitIdField.value;
        if (!data.inquiryType) { alert('å•ã„åˆã‚ã›ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        if (isEdit) {
          google.script.run.withSuccessHandler(function(){
            alert('å•ã„åˆã‚ã›è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            cancelEdit();
            loadVisits(facilityId);
            finishSubmitAttempt();
          }).withFailureHandler(handleSubmitFailure).updateVisit(data);
        } else {
          google.script.run.withSuccessHandler(function(){
            alert('å•ã„åˆã‚ã›è¨˜éŒ²ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
            document.getElementById('visitForm').reset();
            document.getElementById('visitDate').value = nowForDatetimeLocal();
            onInquiryTypeChange();
            loadVisits(facilityId);
            finishSubmitAttempt();
          }).withFailureHandler(handleSubmitFailure).addVisit(data);
        }
      }
      window.addEventListener('load', function(){
        initTheme();
        initFacilityFilters();
        const sel = document.getElementById('visitFacility');
        if (sel) sel.addEventListener('change', onFacilityChange);
        document.getElementById('inquiryType').addEventListener('change', onInquiryTypeChange);
        const outSel = document.getElementById('outcome'); if (outSel) outSel.addEventListener('change', onOutcomeChange);
        document.getElementById('visitDate').value = nowForDatetimeLocal();
        onInquiryTypeChange();
        setVisitSubmitDisabled(true);
      });
    </script>
  </head>
  <body>
    <nav>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=index">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=facilities">æ–½è¨­ç™»éŒ²</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=reports">å–¶æ¥­å ±å‘Š</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=employees">ç¤¾å“¡ç™»éŒ²</a>
  <button id="themeToggleBtn" type="button" onclick="toggleTheme()" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ“</button>
    </nav>

    <h1>å•ã„åˆã‚ã›è¨˜éŒ²</h1>
    <form id="visitForm" onsubmit="event.preventDefault(); submitVisit();">
      <input type="hidden" id="visitId" value="">
      <div style="border:1px solid #eee; border-radius:6px; padding:12px; margin-top:8px;">
        <div class="row" style="margin-top:0;">
          <div>
            <label for="facilityPref">éƒ½é“åºœçœŒ</label>
            <select id="facilityPref">
              <option value="">å…¨ã¦</option>
              <option>æ±äº¬éƒ½</option>
              <option>ç¥å¥ˆå·çœŒ</option>
              <option>åƒè‘‰çœŒ</option>
              <option>åŸ¼ç‰çœŒ</option>
              <option>èŒ¨åŸçœŒ</option>
              <option selected>æ ƒæœ¨çœŒ</option>
              <option>ç¾¤é¦¬çœŒ</option>
              <option>å±±æ¢¨çœŒ</option>
            </select>
          </div>
          <div>
            <label for="facilityMun">å¸‚åŒºç”ºæ‘</label>
            <select id="facilityMun" disabled>
              <option value="">å¸‚åŒºç”ºæ‘ï¼ˆå…¨ã¦ï¼‰</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <div>
            <label for="placementStage">åˆ©ç”¨çŠ¶æ³ï¼ˆå…¥å±…ãƒ—ãƒ­ã‚»ã‚¹ï¼‰</label>
            <select id="placementStage">
              <option value="">æœªè¨­å®š</option>
              <option value="å•ã„åˆã‚ã›">å•ã„åˆã‚ã›</option>
              <option value="è¦‹å­¦å¸Œæœ›">è¦‹å­¦å¸Œæœ›</option>
              <option value="è¦‹å­¦å®Ÿæ–½">è¦‹å­¦å®Ÿæ–½</option>
              <option value="ä½“é¨“åˆ©ç”¨">ä½“é¨“åˆ©ç”¨</option>
              <option value="å…¥å±…ç”³è¾¼">å…¥å±…ç”³è¾¼</option>
              <option value="å…¥å±…">å…¥å±…</option>
            </select>
          </div>
          <div>
            <label for="placementStageDate">è©²å½“æ—¥</label>
            <input id="placementStageDate" type="date">
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <div>
            <label for="outcome">çµæœ</label>
            <select id="outcome">
              <option value="">-- é¸æŠ --</option>
              <option value="æˆç´„">æˆç´„</option>
              <option value="ãŠæ–­ã‚Š">ãŠæ–­ã‚Š</option>
              <option value="æ”¾ç½®/æœªå¯¾å¿œ">æ”¾ç½®/æœªå¯¾å¿œ</option>
            </select>
          </div>
          <div id="rejectionBlock" style="display:none;">
            <label for="rejectionStage">ãŠæ–­ã‚Šæ®µéš</label>
            <select id="rejectionStage">
              <option value="">æœªè¨­å®š</option>
              <option value="å•ã„åˆã‚ã›">å•ã„åˆã‚ã›</option>
              <option value="è¦‹å­¦å¸Œæœ›">è¦‹å­¦å¸Œæœ›</option>
              <option value="è¦‹å­¦å®Ÿæ–½">è¦‹å­¦å®Ÿæ–½</option>
              <option value="ä½“é¨“åˆ©ç”¨">ä½“é¨“åˆ©ç”¨</option>
              <option value="å…¥å±…ç”³è¾¼">å…¥å±…ç”³è¾¼</option>
              <option value="å…¥å±…">å…¥å±…</option>
            </select>
            <label for="rejectionDate" style="margin-top:8px;">ãŠæ–­ã‚Šæ—¥</label>
            <input id="rejectionDate" type="date">
            <label for="rejectionReason" style="margin-top:8px;">ç†ç”±ï¼ˆä»»æ„ï¼‰</label>
            <input id="rejectionReason" type="text" placeholder="ä¾‹: äºˆç®—ãŒåˆã‚ãªã„ã€ä»–æ–½è¨­ã«æ±ºã‚ãŸ ç­‰">
          </div>
        </div>
        <div style="margin-top:8px;">
          <small class="muted">å¸‚åŒºç”ºæ‘ã‚’é¸ã¶ã¨ã€è©²å½“ã™ã‚‹æ–½è¨­ã ã‘ã«çµã‚Šè¾¼ã‚ã¾ã™ã€‚</small>
        </div>
      </div>
      <div id="facilityWrap" style="margin-top:12px;">
        <label for="visitFacility">æ–½è¨­</label>
        <select id="visitFacility"></select>
      </div>
      <div id="activityBox" class="muted" style="margin-top:4px;"></div>
  <div id="conversionBox" class="muted" style="margin-top:4px;"></div>

      <div class="row">
        <div>
          <label for="visitDate">æ—¥æ™‚</label>
          <input type="datetime-local" id="visitDate">
        </div>
        <div>
          <label for="inquiryType">å•ã„åˆã‚ã›ç¨®åˆ¥</label>
          <select id="inquiryType">
            <option value="">-- é¸æŠ --</option>
            <option value="é›»è©±">é›»è©±</option>
            <option value="æ¥è¨ª">æ¥è¨ªï¼ˆåˆ©ç”¨è€…ãƒ»å®¶æ—ç­‰ãŒæ¥æ‰€ï¼‰</option>
          </select>
        </div>
      </div>

      <!-- è©³ç´°æƒ…å ±ï¼ˆé›»è©±/æ¥è¨ª å…±é€šã§å…¥åŠ›å¯èƒ½ï¼‰ -->
      <div id="visitorFields" style="display:block; margin-top:8px; border:1px solid #eee; padding:12px; border-radius:6px;">
        <h3 style="margin:0 0 8px 0; font-size:16px;">ç›¸è«‡è€…æƒ…å ±</h3>
        <div class="row">
          <div>
            <label for="visitorName">ç›¸è«‡è€…å</label>
            <input id="visitorName" type="text" placeholder="ä¾‹: å±±ç”° å¤ªéƒ">
          </div>
          <div>
            <label for="visitorRelation">ç›¸è«‡è€…åŒºåˆ†</label>
            <select id="visitorRelation">
              <option value="">-- é¸æŠ --</option>
              <option value="åˆ©ç”¨è€…æœ¬äºº">åˆ©ç”¨è€…æœ¬äºº</option>
              <option value="å®¶æ—">å®¶æ—</option>
              <option value="ã‚±ã‚¢ãƒãƒ">ã‚±ã‚¢ãƒãƒ</option>
              <option value="åŒ»ç™‚æ©Ÿé–¢">åŒ»ç™‚æ©Ÿé–¢</option>
              <option value="è¡Œæ”¿">è¡Œæ”¿</option>
              <option value="äº‹æ¥­æ‰€">äº‹æ¥­æ‰€</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="callerPhone">ç›¸è«‡è€…é›»è©±</label>
            <input id="callerPhone" type="tel" placeholder="090-1234-5678">
          </div>
          <div>
            <label for="callerEmail">ç›¸è«‡è€…ãƒ¡ãƒ¼ãƒ«ï¼ˆä»»æ„ï¼‰</label>
            <input id="callerEmail" type="email" placeholder="example@example.com">
          </div>
        </div>
        <h3 style="margin:16px 0 8px 0; font-size:16px;">å¯¾è±¡è€…æƒ…å ±</h3>
        <div class="row">
          <div>
            <label for="subjectName">å¯¾è±¡è€…åï¼ˆä»»æ„ï¼‰</label>
            <input id="subjectName" type="text" placeholder="ä¾‹: å±±ç”° èŠ±å­">
          </div>
          <div>
            <label for="subjectAge">å¹´é½¢ï¼ˆä»»æ„ï¼‰</label>
            <input id="subjectAge" type="number" min="0" max="120" placeholder="ä¾‹: 82">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="subjectGender">æ€§åˆ¥</label>
            <select id="subjectGender">
              <option value="">-- é¸æŠ --</option>
              <option value="ç”·æ€§">ç”·æ€§</option>
              <option value="å¥³æ€§">å¥³æ€§</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
              <option value="ä¸æ˜">ä¸æ˜</option>
            </select>
          </div>
          <div>
            <label for="residenceMunicipality">å±…ä½åœ°ï¼ˆå¸‚åŒºç”ºæ‘ï¼‰</label>
            <input id="residenceMunicipality" type="text" placeholder="ä¾‹: æ¨ªæµœå¸‚æ¸¯åŒ—åŒº">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="diagnosis">ç–¾æ‚£å / ä¸»ãªè¨ºæ–­</label>
            <input id="diagnosis" type="text" placeholder="ä¾‹: èªçŸ¥ç—‡, è„³æ¢—å¡å¾Œéºç—‡ ãªã©">
          </div>
          <div>
            <label for="disabilityCategory">éšœå®³åŒºåˆ†</label>
            <select id="disabilityCategory" multiple size="4" title="Ctrl+ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯Shift+ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠã§ãã¾ã™">
              <option value="">-- é¸æŠ --</option>
              <option value="èº«ä½“éšœå®³">èº«ä½“éšœå®³</option>
              <option value="çŸ¥çš„éšœå®³">çŸ¥çš„éšœå®³</option>
              <option value="ç²¾ç¥éšœå®³">ç²¾ç¥éšœå®³</option>
              <option value="é«˜é½¢ã«ã‚ˆã‚‹è¦ä»‹è­·">é«˜é½¢ï¼ˆè¦ä»‹è­·ï¼‰</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="careLevel">è¦ä»‹è­·åº¦</label>
            <select id="careLevel">
              <option value="">-- é¸æŠ --</option>
              <option value="è‡ªç«‹">è‡ªç«‹</option>
              <option value="è¦æ”¯æ´1">è¦æ”¯æ´1</option>
              <option value="è¦æ”¯æ´2">è¦æ”¯æ´2</option>
              <option value="è¦ä»‹è­·1">è¦ä»‹è­·1</option>
              <option value="è¦ä»‹è­·2">è¦ä»‹è­·2</option>
              <option value="è¦ä»‹è­·3">è¦ä»‹è­·3</option>
              <option value="è¦ä»‹è­·4">è¦ä»‹è­·4</option>
              <option value="è¦ä»‹è­·5">è¦ä»‹è­·5</option>
              <option value="ä¸æ˜">ä¸æ˜</option>
            </select>
          </div>
          <div>
            <label for="desiredStartDate">å¸Œæœ›é–‹å§‹æ™‚æœŸï¼ˆä»»æ„ï¼‰</label>
            <input id="desiredStartDate" type="date">
          </div>
        </div>
        <div>
          <label>å¸Œæœ›ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
          <label style="display:block; margin-top:4px;"><input type="checkbox" id="wantsGroupHome"> ã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ å¸Œæœ›</label>
          <label style="display:block; margin-top:4px;"><input type="checkbox" id="wantsHomeNursing"> è¨ªå•çœ‹è­·å¸Œæœ›</label>
        </div>
        <h3 style="margin:16px 0 8px 0; font-size:16px;">é€£çµ¡ãƒ»ãã®ä»–</h3>
        <div class="row">
          <div>
            <label for="urgency">ç·Šæ€¥åº¦</label>
            <select id="urgency">
              <option value="">-- é¸æŠ --</option>
              <option value="é«˜">é«˜</option>
              <option value="ä¸­">ä¸­</option>
              <option value="ä½">ä½</option>
            </select>
          </div>
          <div>
            <label for="preferredContactMethod">é€£çµ¡æ‰‹æ®µã®å¸Œæœ›</label>
            <select id="preferredContactMethod">
              <option value="">-- é¸æŠ --</option>
              <option value="é›»è©±">é›»è©±</option>
              <option value="ãƒ¡ãƒ¼ãƒ«">ãƒ¡ãƒ¼ãƒ«</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="preferredContactTime">é€£çµ¡å¸Œæœ›æ™‚é–“å¸¯ï¼ˆä»»æ„ï¼‰</label>
            <input id="preferredContactTime" type="text" placeholder="ä¾‹: å¹³æ—¥ 10:00-12:00">
          </div>
          <div>
            <label for="referralSource">æƒ…å ±çµŒè·¯</label>
            <select id="referralSource">
              <option value="">-- é¸æŠ --</option>
              <option value="ç´¹ä»‹(ã‚±ã‚¢ãƒãƒ)">ç´¹ä»‹(ã‚±ã‚¢ãƒãƒ)</option>
              <option value="ç—…é™¢">ç—…é™¢</option>
              <option value="è¡Œæ”¿">è¡Œæ”¿</option>
              <option value="ãƒãƒƒãƒˆæ¤œç´¢">ãƒãƒƒãƒˆæ¤œç´¢</option>
              <option value="ãƒãƒ©ã‚·ãƒ»ãƒã‚¹ã‚¿ãƒ¼">ãƒãƒ©ã‚·ãƒ»ãƒã‚¹ã‚¿ãƒ¼</option>
              <option value="é€šã‚ŠãŒã‹ã‚Š">é€šã‚ŠãŒã‹ã‚Š</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
          </div>
        </div>
        <label style="display:block; margin-top:4px;"><input type="checkbox" id="consentFlag"> é€£çµ¡ãƒ»å€‹äººæƒ…å ±ã®å–æ‰±ã„ã«ã¤ã„ã¦åŒæ„ã‚’å¾—ãŸ</label>
      </div>

      <label for="visitPurpose" style="margin-top:12px;">è¦ä»¶ / ç›®çš„</label>
      <input id="visitPurpose" type="text" placeholder="ä¾‹: å…¥å±…ç›¸è«‡ã€ã‚µãƒ¼ãƒ“ã‚¹å†…å®¹ã®ç¢ºèª ãªã©">

      <label for="notes">å‚™è€ƒ</label>
      <textarea id="notes" rows="3" placeholder="è‡ªç”±è¨˜å…¥"></textarea>

  <button type="submit" id="visitSubmitBtn">è¨˜éŒ²ã‚’ç™»éŒ²</button>
  <button type="button" id="cancelEditBtn" style="display:none; margin-left:8px;" onclick="cancelEdit()">ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </form>

    <h2>æ–½è¨­åˆ¥ã®å•ã„åˆã‚ã›ä¸€è¦§</h2>
    <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>æ—¥æ™‚</th>
          <th>ç¨®åˆ¥</th>
          <th>ç›¸è«‡è€…/å¯¾è±¡è€…</th>
          <th>è¦ä»¶</th>
          <th>è¨ºæ–­/åŒºåˆ†/å¸Œæœ›</th>
          <th>æ®µéš</th>
          <th>å‚™è€ƒ</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="visitRows">
        <tr><td colspan="8">æ–½è¨­ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>
      </tbody>
    </table>
    </div>
  </body>
 </html>