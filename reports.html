<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial, sans-serif; padding: 24px; }
      nav a { margin-right: 12px; }
      label { display: block; margin-top: 12px; }
      input, textarea, select { width: 100%; padding: 6px; }
      button { margin-top: 16px; padding: 8px 16px; }
      table { width: 100%; border-collapse: collapse; margin-top: 24px; }
      th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; vertical-align: top; }
      h2 { margin-top: 28px; }
    </style>
    <script>
      function submitReport() {
        const facilityId = document.getElementById('reportFacility').value;
        const reporterSelect = document.getElementById('reporterSelect');
        const reporterName = reporterSelect && reporterSelect.value ? reporterSelect.options[reporterSelect.selectedIndex].text : '';
  const contactSelect = document.getElementById('contactSelect');
  const contactId = contactSelect && contactSelect.value ? contactSelect.value : '';
  const contactName = contactSelect && contactSelect.value ? contactSelect.options[contactSelect.selectedIndex].text : '';
        const channelSelect = document.getElementById('channelSelect');
        let channel = channelSelect.value;
        if (channel === 'その他') {
          const other = document.getElementById('channelOther').value.trim();
          if (!other) { alert('その他の詳細を入力してください'); return; }
          channel = 'その他:' + other;
        }
        const data = {
          facilityId: facilityId,
          reportDate: document.getElementById('reportDate').value,
          reporterName: reporterName,
          reporterEmail: '',
          channel: channel,
          contactId: contactId,
          contactName: contactName,
          summary: document.getElementById('summary').value,
          details: document.getElementById('details').value,
          followUp: document.getElementById('followUp').value
        };
        if (!data.facilityId) { alert('施設を選択してください'); return; }
        if (!data.summary) { alert('要約を入力してください'); return; }
        if (!reporterName) { alert('報告者を選択してください'); return; }
        if (!channelSelect.value) { alert('報告方法を選択してください'); return; }
        google.script.run.withSuccessHandler(function() {
          alert('営業報告を登録しました');
          document.getElementById('reportForm').reset();
          loadReports(data.facilityId);
          // 選択リセット
          if (reporterSelect) reporterSelect.selectedIndex = 0;
          if (channelSelect) channelSelect.selectedIndex = 0;
          if (contactSelect) contactSelect.selectedIndex = 0;
          document.getElementById('channelOtherWrap').style.display = 'none';
        }).addReport(data);
      }

      function loadFacilities() {
        google.script.run.withSuccessHandler(function(list) {
          const select = document.getElementById('reportFacility');
          select.innerHTML = '<option value="">-- 施設を選択 --</option>';
          list.forEach(function(f) {
            const opt = document.createElement('option');
            opt.value = f.id;
            opt.textContent = f.name + (f.address ? ' — ' + f.address : '');
            select.appendChild(opt);
          });
        }).getFacilities();
      }

      function loadReports(facilityId) {
        if (!facilityId) {
          document.getElementById('reportRows').innerHTML = '<tr><td colspan="6">施設を選択してください</td></tr>';
          return;
        }
        google.script.run.withSuccessHandler(function(list) {
          const tbody = document.getElementById('reportRows');
          if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">営業報告はありません</td></tr>';
            return;
          }
          let html = '';
          list.forEach(function(r) {
      html += '<tr><td>' + escapeHtml(r.reportDate || r.createdAt) + '</td>' +
                    '<td>' + escapeHtml(r.channel || '') + '</td>' +
                    '<td>' + escapeHtml(r.summary) + '</td>' +
                    '<td>' + escapeHtml(r.contactName || '') + '</td>' +
                    '<td>' + escapeHtml(r.reporterName || r.createdBy || '') + '</td>' +
                    '<td>' + escapeHtml(r.details || '') + '<br><em>' + escapeHtml(r.followUp || '') + '</em></td></tr>';
          });
          tbody.innerHTML = html;
        }).getReports({ facilityId: facilityId });
      }

      function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }

      function loadEmployeesForReporter() {
        const sel = document.getElementById('reporterSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="">-- 報告者を選択 --</option>';
        google.script.run.withSuccessHandler(function(list) {
          list.forEach(function(emp) {
            const opt = document.createElement('option');
            opt.value = emp.id; // 現状は名前のみ保存。将来用にIDも保持
            opt.textContent = emp.name || '';
            sel.appendChild(opt);
          });
        }).getEmployees();
      }

      function loadContactsForFacility(facilityId) {
        const sel = document.getElementById('contactSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="">-- 担当者を選択 --</option>';
        sel.disabled = true;
        const infoBox = document.getElementById('contactInfoBox');
        if (infoBox) infoBox.textContent = '';
        if (!facilityId) return;
        google.script.run.withSuccessHandler(function(list) {
          list.forEach(function(c) {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.contactName || '';
            opt.setAttribute('data-notes', c.contactNotes || '');
            sel.appendChild(opt);
          });
          sel.disabled = false;
        }).getFacilityContacts({ facilityId: facilityId });
      }
      function showSelectedContactNotes() {
        const sel = document.getElementById('contactSelect');
        const infoBox = document.getElementById('contactInfoBox');
        if (!sel || !infoBox) return;
        const opt = sel.options[sel.selectedIndex];
        if (!opt || !opt.value) { infoBox.textContent = ''; return; }
        const notes = opt.getAttribute('data-notes') || '';
        infoBox.textContent = notes ? ('備考: ' + notes) : '';
      }

      window.addEventListener('load', function() {
        loadFacilities();
        loadEmployeesForReporter();
        document.getElementById('reportFacility').addEventListener('change', function() {
          loadReports(this.value);
          loadContactsForFacility(this.value);
        });
          document.getElementById('contactSelect').addEventListener('change', showSelectedContactNotes);
        document.getElementById('channelSelect').addEventListener('change', function(){
          if (this.value === 'その他') {
            document.getElementById('channelOtherWrap').style.display = 'block';
          } else {
            document.getElementById('channelOtherWrap').style.display = 'none';
            document.getElementById('channelOther').value = '';
          }
        });
      });
    </script>
  </head>
  <body>
    <nav>
      <!-- 絶対URL化で iframe / 相対リンクの /blank 問題を回避 -->
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=index">メニューに戻る</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=facilities">施設登録</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=visits">来訪記録</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=employees">社員登録</a>
    </nav>

    <h1>営業報告</h1>
    <form id="reportForm" onsubmit="event.preventDefault(); submitReport();">
      <label for="reportFacility">施設</label>
      <select id="reportFacility" required></select>
      <label for="reportDate">報告日時</label>
      <input type="datetime-local" id="reportDate">
      <label for="channelSelect">報告方法</label>
      <select id="channelSelect" required>
        <option value="">-- 選択してください --</option>
        <option value="訪問">訪問</option>
        <option value="電話">電話</option>
        <option value="利用者送迎">利用者送迎</option>
        <option value="FAX">FAX</option>
        <option value="メール">メール</option>
        <option value="オンライン">オンライン</option>
        <option value="その他">その他</option>
      </select>
      <div id="channelOtherWrap" style="display:none;">
        <label for="channelOther">その他詳細</label>
        <input type="text" id="channelOther" placeholder="具体的な方法を記載">
      </div>
      <label for="contactSelect">対応担当者（施設担当者）</label>
      <select id="contactSelect" disabled>
        <option value="">-- 施設を先に選択 --</option>
      </select>
      <div id="contactInfoBox" style="margin:4px 0 12px; font-size:13px; color:#555;"></div>
      <label for="reporterSelect">報告者（社員）</label>
      <select id="reporterSelect" required>
        <option value="">-- 読み込み中 --</option>
      </select>
      <label for="summary">要約（必須）</label>
      <input type="text" id="summary" required>
      <label for="details">詳細</label>
      <textarea id="details" rows="4"></textarea>
      <label for="followUp">フォローアップ / 次アクション</label>
      <input type="text" id="followUp">
      <button type="submit">営業報告を登録</button>
    </form>

    <h2>施設別の営業報告</h2>
    <table>
      <thead>
        <tr><th>報告日時</th><th>方法</th><th>要約</th><th>担当者</th><th>報告者</th><th>詳細 / フォローアップ</th></tr>
      </thead>
      <tbody id="reportRows">
        <tr><td colspan="6">施設を選択してください</td></tr>
      </tbody>
    </table>
  </body>
</html>
