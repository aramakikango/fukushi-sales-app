<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      :root { color-scheme: light dark; }
      *, *::before, *::after { box-sizing: border-box; }
      html, body { width:100%; max-width:100%; overflow-x:hidden; }
  body {
        font-family: Arial, sans-serif;
        margin: 0;
        --page-padding: 24px;
        padding: var(--page-padding);
      }
  .fullbleed { display:block; }
      nav { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
      nav a {
        flex:1 1 180px;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        padding:12px 16px;
        border-radius:12px;
        border:1px solid #0c66d4;
        background:#fff;
        color:#0c66d4;
        text-decoration:none;
        font-weight:600;
        min-height:56px;
        transition:background .18s ease, color .18s ease;
      }
      nav a:hover,
      nav a:focus {
        background:#0c66d4;
        color:#fff;
      }
      /* compact floating theme toggle (icon) */
      #themeToggleBtn {
        width:44px; height:44px; display:flex; align-items:center; justify-content:center;
        position:fixed; top:12px; right:12px; z-index:9999;
        border-radius:999px; border:1px solid rgba(12,102,212,0.12);
        background:#fff; color:#0c66d4; box-shadow:0 2px 6px rgba(0,0,0,0.08); cursor:pointer;
        font-size:18px; line-height:1;
      }
      #themeToggleBtn:hover { transform:scale(1.06); }
  label { display: block; margin-top: 12px; }
      input, textarea, select { width: 100%; padding: 6px; }
      button {
        margin-top: 16px;
        padding: clamp(12px, 2vw, 18px) clamp(18px, 3vw, 26px);
        font-size: clamp(16px, 2vw + 10px, 22px);
        min-height: 58px;
        border-radius: 14px;
      }
  .table-wrap { width:100%; overflow-x:auto; -webkit-overflow-scrolling: touch; }
      table { width: 100%; border-collapse: collapse; margin-top: 24px; min-width: 720px; }
      th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; vertical-align: top; }
      h2 { margin-top: 28px; }
      .muted { color:#666; font-size:12px; }
  .next-action-grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
  .grid3 { display:grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr) minmax(0,1fr); gap: 8px; }
  .action-row { margin-top:8px; display:grid; grid-template-columns: minmax(0,1fr) auto; gap:8px; }
  .action-row button { margin-top:0; }
  .contact-panel-toggle { margin:0 0 12px; }
  .contact-panel-toggle button { margin-top:0; padding:10px 16px; }
      @media (max-width: 900px) { .grid3 { grid-template-columns: 1fr 1fr; } }
      @media (max-width: 560px) { .grid3 { grid-template-columns: 1fr; } }
      .digest-wrap { margin-top: 8px; }
      .digest-cards { display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; }
      .digest-card { border:1px solid #eee; border-radius:6px; padding:8px; font-size:12px; background:#fafafa; }
      .digest-card .title { font-weight:bold; font-size:12px; margin-bottom:4px; }
      .digest-card .meta { color:#555; margin-bottom:4px; }
      @media (max-width: 900px) { .digest-cards { grid-template-columns: repeat(2, 1fr); } }
      @media (max-width: 520px) { .digest-cards { grid-template-columns: 1fr; } }
      @media (max-width: 720px) { .next-action-grid { grid-template-columns: 1fr; } }
      .edge-expand {
        margin-left: calc(var(--page-padding) * -1);
        margin-right: calc(var(--page-padding) * -1);
        padding-left: var(--page-padding);
        padding-right: var(--page-padding);
      }
      @media (max-width: 900px) {
        nav { flex-direction: column; align-items: stretch; }
        nav a, nav button { width: 100%; margin: 0 0 8px 0; border-radius: 12px; min-height: clamp(56px, 9vh, 68px); font-size: clamp(16px, 2vw + 12px, 20px); padding: clamp(14px,2vh,18px) 18px; }
        nav a { margin-right: 0; }
        .action-row { grid-template-columns: 1fr; }
        .action-row button { width: 100%; justify-self: stretch; }
        button, .contact-panel-toggle button, #newContactPanel button, table button { width: 100%; border-radius: 12px; margin: 0 0 12px 0; }
        .action-row button:last-child { margin-bottom: 0; }
      }
  @media (max-width: 640px) {
        body { --page-padding:16px; padding: var(--page-padding); }
        input, select, textarea { font-size:18px; }
        button { padding:12px 16px; min-height:clamp(48px,8vh,64px); font-size:clamp(16px,2.8vw + 12px,20px); width:100%; border-radius:10px; }
        .action-row { grid-template-columns: 1fr; }
    .table-wrap button,
    .digest-card button,
    #newContactPanel button,
    .contact-panel-toggle button { font-size:clamp(16px,2.8vw + 12px,20px); }
    .fullbleed { margin-left: calc(var(--page-padding) * -1); margin-right: calc(var(--page-padding) * -1); padding-left: var(--page-padding); padding-right: var(--page-padding); }
      }
      /* Mobile: stack nav vertically and make full-width buttons */
      @media (max-width: 650px) {
        nav { flex-direction: column; align-items: stretch; }
        nav a, nav button { width: 100%; margin: 0 0 8px 0; border-radius: 10px; min-height: clamp(56px,10vh,72px); font-size: clamp(16px, 2.8vw + 12px, 20px); padding: clamp(14px,2vh,18px) 18px; }
  nav a { margin-right: 0; }
      }
      @media (prefers-color-scheme: dark) {
        body { background:#111; color:#eaeaea; }
        th, td { border-bottom:1px solid #333; }
        input, textarea, select { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
        button { background:#2a2a2a; color:#eaeaea; border:1px solid #444; }
        nav a { background:#1a1a1a; border-color:#3769e6; color:#8ab4ff; }
        nav a:hover, nav a:focus { background:#1f3a75; color:#fff; }
        .digest-card { background:#1a1a1a; border-color:#333; }
        .digest-card .meta { color:#aaa; }
        .muted { color:#aaa; }
      }
      /* Manual theme override classes */
      body.theme-dark { background:#111; color:#eaeaea; }
      body.theme-dark th, body.theme-dark td { border-bottom:1px solid #333; }
      body.theme-dark input, body.theme-dark textarea, body.theme-dark select { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
      body.theme-dark button { background:#2a2a2a; color:#eaeaea; border:1px solid #444; }
      body.theme-dark .digest-card { background:#1a1a1a; border-color:#333; }
      body.theme-dark .digest-card .meta, body.theme-dark .muted { color:#aaa; }
      body.theme-light { background:#fff; color:#111; }
      body.theme-dark nav a { background:#1a1a1a; border-color:#3769e6; color:#8ab4ff; }
      body.theme-dark nav a:hover, body.theme-dark nav a:focus { background:#1f3a75; color:#fff; }
      body.theme-light nav a { background:#fff; border-color:#0c66d4; color:#0c66d4; }
      body.theme-light nav a:hover, body.theme-light nav a:focus { background:#0c66d4; color:#fff; }
      body.theme-dark #themeToggleBtn { background:#1a1a1a; color:#8ab4ff; border-color:#3769e6; }
      body.theme-dark #themeToggleBtn:hover { background:#1f3a75; color:#eaeaea; }
    </style>
    <script>
  // Theme toggle
  function applyTheme(pref){ document.body.classList.remove('theme-dark','theme-light'); if(pref==='dark')document.body.classList.add('theme-dark'); if(pref==='light')document.body.classList.add('theme-light'); }
  function updateThemeButton(pref){ const b=document.getElementById('themeToggleBtn'); if(!b) return; if(pref==='dark'){ b.innerHTML='ğŸŒ™'; b.title='ãƒ†ãƒ¼ãƒ: ãƒ€ãƒ¼ã‚¯'; b.setAttribute('aria-label','ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰'); } else if(pref==='light'){ b.innerHTML='â˜€ï¸'; b.title='ãƒ†ãƒ¼ãƒ: ãƒ©ã‚¤ãƒˆ'; b.setAttribute('aria-label','ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰'); } else { b.innerHTML='ğŸŒ“'; b.title='ãƒ†ãƒ¼ãƒ: è‡ªå‹•'; b.setAttribute('aria-label','ãƒ†ãƒ¼ãƒ: è‡ªå‹•'); } }
  function initTheme(){ const p=localStorage.getItem('theme')||'system'; applyTheme(p); updateThemeButton(p); }
  function toggleTheme(){ const cur=localStorage.getItem('theme')||'system'; const next=cur==='system'?'dark':(cur==='dark'?'light':'system'); localStorage.setItem('theme',next); applyTheme(next); updateThemeButton(next); }
      // å–å¾—ã—ãŸå–¶æ¥­å ±å‘Šã®ç°¡æ˜“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚³ãƒ”ãƒ¼ã«ä½¿ç”¨ï¼‰
      let REPORT_CACHE = {};
      function nowForDatetimeLocal() {
        const d = new Date();
        const pad = (n) => String(n).padStart(2,'0');
        const yyyy = d.getFullYear();
        const MM = pad(d.getMonth()+1);
        const dd = pad(d.getDate());
        const hh = pad(d.getHours());
        const mm = pad(d.getMinutes());
        return `${yyyy}-${MM}-${dd}T${hh}:${mm}`;
      }
      function submitReport() {
        const facilityId = document.getElementById('reportFacility').value;
        const reporterSelect = document.getElementById('reporterSelect');
        const reporterName = reporterSelect && reporterSelect.value ? reporterSelect.options[reporterSelect.selectedIndex].text : '';
  const contactSelect = document.getElementById('contactSelect');
  const contactId = contactSelect && contactSelect.value ? contactSelect.value : '';
  let contactName = '';
  if (document.getElementById('unknownContactChk').checked) {
    contactName = 'ä¸æ˜';
  } else {
    contactName = contactSelect && contactSelect.value ? contactSelect.options[contactSelect.selectedIndex].text : '';
  }
        const channelSelect = document.getElementById('channelSelect');
        let channel = channelSelect.value;
        if (channel === 'ãã®ä»–') {
          const other = document.getElementById('channelOther').value.trim();
          if (!other) { alert('ãã®ä»–ã®è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
          channel = 'ãã®ä»–:' + other;
        }
        // æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆ + ãã®ä»–è©³ç´°ï¼‰
        let nextActionValue = '';
        const nextActionSelect = document.getElementById('nextActionSelect');
        if (nextActionSelect) {
          if (nextActionSelect.value === 'ãã®ä»–') {
            const manual = document.getElementById('nextActionManual').value.trim();
            if (!manual) { alert('æ¬¡ã«ã‚„ã‚‹ã“ã¨ã®ã€Œãã®ä»–ã€è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            nextActionValue = 'ãã®ä»–:' + manual;
          } else {
            nextActionValue = nextActionSelect.value || '';
          }
        }
        const data = {
          facilityId: facilityId,
          reportDate: document.getElementById('reportDate').value,
          reporterName: reporterName,
          reporterEmail: '',
          channel: channel,
          contactId: contactId,
          contactName: contactName,
          summary: document.getElementById('summary').value,
          details: document.getElementById('details').value,
          followUp: document.getElementById('followUp').value,
          nextAction: nextActionValue,
          nextActionDate: document.getElementById('nextActionDate').value,
          nextActionOwner: document.getElementById('nextActionOwner').value,
          priority: document.getElementById('priority').value,
          statusStage: document.getElementById('statusStage').value,
          reminderFlag: document.getElementById('reminderFlag').checked
        };
        if (!data.facilityId) { alert('æ–½è¨­ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        if (!data.summary) { alert('è¦ç´„ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        if (!reporterName) { alert('å ±å‘Šè€…ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        if (!channelSelect.value) { alert('å ±å‘Šæ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        if (!nextActionValue && document.getElementById('statusStage').value && document.getElementById('nextActionSelect').options.length > 1) {
          // ã‚¹ãƒ†ãƒ¼ã‚¸ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã®ã«æœªé¸æŠãªã‚‰æ³¨æ„ï¼ˆå¿…é ˆã«ã¯ã—ãªã„ãŒä¿ƒã™ï¼‰
          if (!confirm('æ¬¡ã«ã‚„ã‚‹ã“ã¨ãŒæœªé¸æŠã§ã™ã€‚ç©ºã®ã¾ã¾ã§ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ')) return;
        }
        google.script.run.withSuccessHandler(function() {
          alert('å–¶æ¥­å ±å‘Šã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
          // æœ€è¿‘ä½¿ã£ãŸæ–½è¨­ã‚’ä¿å­˜ï¼ˆæœ€å¤§5ä»¶ï¼‰
          try {
            if (facilityId) {
              const key = 'recentFacilities';
              const arr = JSON.parse(localStorage.getItem(key) || '[]');
              const next = [facilityId].concat(arr.filter(id => id !== facilityId)).slice(0,5);
              localStorage.setItem(key, JSON.stringify(next));
            }
          } catch(e){}
          document.getElementById('reportForm').reset();
          loadReports(data.facilityId);
          // é¸æŠãƒªã‚»ãƒƒãƒˆ
          if (reporterSelect) reporterSelect.selectedIndex = 0;
          if (channelSelect) channelSelect.selectedIndex = 0;
          if (contactSelect) contactSelect.selectedIndex = 0;
          document.getElementById('channelOtherWrap').style.display = 'none';
          // è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ãƒªã‚»ãƒƒãƒˆ
          resetNextActionSelect();
          document.getElementById('nextActionDate').value = '';
          document.getElementById('nextActionOwner').value = '';
          document.getElementById('priority').selectedIndex = 0;
          document.getElementById('statusStage').selectedIndex = 0;
          document.getElementById('reminderFlag').checked = false;
        }).addReport(data);
      }

      // æ–½è¨­å€™è£œã®ãƒ•ã‚£ãƒ«ã‚¿UI
      function onFacilityPrefChange(){
        const pref = document.getElementById('facilityPref').value;
        const munSel = document.getElementById('facilityMun');
        munSel.innerHTML = '<option value="">å…¨ã¦</option>';
        if (!pref) { updateFacilityOptions(); return; }
        google.script.run.withSuccessHandler(function(list){
          munSel.innerHTML = '<option value="">å…¨ã¦</option>';
          list.forEach(function(m){ const o=document.createElement('option'); o.value=m.municipality; o.textContent=m.municipality; munSel.appendChild(o); });
          updateFacilityOptions();
        }).getMunicipalities({ prefecture: pref });
      }
      function updateFacilityOptions(){
        const pref = document.getElementById('facilityPref').value || '';
        const mun = document.getElementById('facilityMun').value || '';
        const type = document.getElementById('facilityTypeFilter').value || '';
        const kw = document.getElementById('facilityKw').value || '';
        const params = { prefecture: pref, municipality: mun, facilityType: type, q: kw, limit: 400 };
        // ç©ºå€¤ã‚’å‰Šé™¤
        Object.keys(params).forEach(k=>{ if (!params[k]) delete params[k]; });
    const select = document.getElementById('reportFacility');
        select.innerHTML = '<option value="">æ¤œç´¢ä¸­...</option>';
        google.script.run.withSuccessHandler(function(list){
          // æœ€è¿‘ä½¿ã£ãŸæ–½è¨­ã‚’ä¸Šä½ã«
          let recentIds=[]; try { recentIds = JSON.parse(localStorage.getItem('recentFacilities')||'[]'); } catch(e){}
          const byId = {}; (list||[]).forEach(f=> byId[f.id]=f);
          const recent = recentIds.map(id => byId[id]).filter(Boolean);
          const rest = (list||[]).filter(f=> recentIds.indexOf(f.id)===-1);
          const reorder = recent.concat(rest);
          select.innerHTML = '';
          if (!reorder.length) {
            const opt = document.createElement('option'); opt.value=''; opt.textContent='è©²å½“ã™ã‚‹æ–½è¨­ãŒã‚ã‚Šã¾ã›ã‚“'; select.appendChild(opt);
            return;
          }
          if (recent.length) {
            const og = document.createElement('optgroup'); og.label = 'æœ€è¿‘ä½¿ã£ãŸæ–½è¨­';
            recent.forEach(function(f){
              const opt = document.createElement('option');
              opt.value = f.id;
              opt.textContent = f.name + (f.municipality? 'ï¼ˆ'+f.municipality+'ï¼‰':'');
              if (f.facilityType) opt.setAttribute('data-facility-type', f.facilityType);
              if (f.address) opt.setAttribute('data-address', f.address);
              if (f.notes) opt.setAttribute('data-notes', f.notes);
              og.appendChild(opt);
            });
            select.appendChild(og);
          }
          const og2 = document.createElement('optgroup'); og2.label = 'å…¨å€™è£œ';
          reorder.forEach(function(f){
            const opt = document.createElement('option');
            opt.value = f.id;
            opt.textContent = f.name + (f.municipality? 'ï¼ˆ'+f.municipality+'ï¼‰':'');
            if (f.facilityType) opt.setAttribute('data-facility-type', f.facilityType);
            if (f.address) opt.setAttribute('data-address', f.address);
            if (f.notes) opt.setAttribute('data-notes', f.notes);
            og2.appendChild(opt);
          });
          select.appendChild(og2);
          showSelectedFacilityDescription();
        }).searchFacilities(params);
      }
      let __facKwTimer=null;
      function updateFacilityOptionsDebounced(){
        if (__facKwTimer) clearTimeout(__facKwTimer);
        __facKwTimer = setTimeout(updateFacilityOptions, 250);
      }

      function showSelectedFacilityDescription(){
        const sel = document.getElementById('reportFacility');
        const box = document.getElementById('facilityDescBox');
        if (!sel || !box) return;
        const opt = sel.options[sel.selectedIndex];
        if (!opt || !opt.value) { box.textContent = ''; return; }
        const notes = opt.getAttribute('data-notes') || '';
        box.textContent = notes ? ('èª¬æ˜: ' + notes) : '';
      }

      function loadReports(facilityId) {
        if (!facilityId) {
          document.getElementById('reportRows').innerHTML = '<tr><td colspan="6">æ–½è¨­ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>';
          document.getElementById('activityBox').innerHTML = '';
          renderRecentDigest([]);
          return;
        }
        // æ´»å‹•ã‚µãƒãƒªãƒ¼
        google.script.run.withSuccessHandler(function(s){
          const box = document.getElementById('activityBox');
          if (!s) { box.innerHTML = ''; return; }
          const lastV = s.lastVisitDate ? new Date(s.lastVisitDate).toLocaleString() : '-';
          const lastR = s.lastReportDate ? new Date(s.lastReportDate).toLocaleString() : '-';
          box.innerHTML = 'è¨ªå•å›æ•°: <b>'+ (s.visitCount||0) +'</b>ï¼ˆæœ€çµ‚: '+ lastV +'ï¼‰ / å ±å‘Šå›æ•°: <b>'+ (s.reportCount||0) +'</b>ï¼ˆæœ€çµ‚: '+ lastR +'ï¼‰';
        }).getFacilityActivitySummary(facilityId);
        google.script.run.withSuccessHandler(function(list) {
          const tbody = document.getElementById('reportRows');
          if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">å–¶æ¥­å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
            renderRecentDigest([]);
            return;
          }
          REPORT_CACHE = {};
          let html = '';
          list.forEach(function(r) {
      REPORT_CACHE[r.id] = r;
      html += '<tr><td>' + escapeHtml(r.reportDate || r.createdAt) + '</td>' +
                    '<td>' + escapeHtml(r.channel || '') + '</td>' +
                    '<td>' + escapeHtml(r.summary) + '</td>' +
                    '<td>' + escapeHtml(r.contactName || '') + '</td>' +
                    '<td>' + escapeHtml(r.reporterName || r.createdBy || '') + '</td>' +
                    '<td>' + escapeHtml(r.details || '')
                        + (r.followUp ? ('<br><em>Follow: ' + escapeHtml(r.followUp) + '</em>') : '')
                        + (r.nextAction ? ('<div class="muted">æ¬¡: ' + escapeHtml(r.nextAction) + (r.nextActionDate? ('ï¼ˆ' + escapeHtml(r.nextActionDate) + 'ï¼‰') : '') + '</div>') : '')
                        + (r.statusStage || r.priority ? ('<div class="muted">' + escapeHtml(r.statusStage||'') + (r.priority? (' / ' + escapeHtml(r.priority)) : '') + (r.nextActionOwner? (' / ' + escapeHtml(r.nextActionOwner)) : '') + '</div>') : '')
                        + '<div style="margin-top:6px;"><button type="button" onclick="copyReport(\'' + String(r.id).replace(/'/g,"&#39;") + '\')">ã‚³ãƒ”ãƒ¼</button></div>'
                        + '</td></tr>';
          });
          tbody.innerHTML = html;
          renderRecentDigest(list);
        }).getReports({ facilityId: facilityId });
      }

      function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }

      function loadEmployeesForReporter() {
        const sel = document.getElementById('reporterSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="">-- å ±å‘Šè€…ã‚’é¸æŠ --</option>';
        google.script.run.withSuccessHandler(function(list) {
          list.forEach(function(emp) {
            const opt = document.createElement('option');
            opt.value = emp.id; // ç¾çŠ¶ã¯åå‰ã®ã¿ä¿å­˜ã€‚å°†æ¥ç”¨ã«IDã‚‚ä¿æŒ
            opt.textContent = emp.name || '';
            sel.appendChild(opt);
          });
          // æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ‹…å½“ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰ã«ã‚‚åŒã˜å€™è£œã‚’å…¥ã‚Œã‚‹
          const ownerSel = document.getElementById('nextActionOwner');
          if (ownerSel) {
            ownerSel.innerHTML = '<option value="">æœªæŒ‡å®š</option>';
            list.forEach(function(emp){
              const o = document.createElement('option'); o.value = emp.name || ''; o.textContent = emp.name || ''; ownerSel.appendChild(o);
            });
          }
        }).getEmployees();
      }

      function loadContactsForFacility(facilityId, selectedId) {
        const sel = document.getElementById('contactSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="">-- æ‹…å½“è€…ã‚’é¸æŠ --</option>';
        sel.disabled = true;
        const infoBox = document.getElementById('contactInfoBox');
        if (infoBox) infoBox.textContent = '';
        // æ–½è¨­é¸æŠæ™‚ã§ã‚‚è‡ªå‹•ã§ã¯è¡¨ç¤ºã—ãªã„ï¼ˆè¿½åŠ ãƒœã‚¿ãƒ³ã§é–‹é–‰ï¼‰
        const newPanel = document.getElementById('newContactPanel');
        if (newPanel) newPanel.style.display = 'none';
        resetNewContactPanelFields();
        if (!facilityId) return;
        google.script.run.withSuccessHandler(function(list) {
          list.forEach(function(c) {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.contactName || '';
            opt.setAttribute('data-notes', c.contactNotes || '');
            sel.appendChild(opt);
          });
          sel.disabled = false;
          if (selectedId) {
            sel.value = selectedId;
            showSelectedContactNotes();
          }
        }).getFacilityContacts({ facilityId: facilityId });
      }
      function showSelectedContactNotes() {
        const sel = document.getElementById('contactSelect');
        const infoBox = document.getElementById('contactInfoBox');
        if (!sel || !infoBox) return;
        const opt = sel.options[sel.selectedIndex];
        if (!opt || !opt.value) { infoBox.textContent = ''; return; }
        const notes = opt.getAttribute('data-notes') || '';
        infoBox.textContent = notes ? ('å‚™è€ƒ: ' + notes) : '';
        // æ‹…å½“è€…ã‚’é¸ã‚“ã ã‚‰ã€Œæ‹…å½“è€…ä¸æ˜ã€ã¯è‡ªå‹•ã§å¤–ã™
        const unk = document.getElementById('unknownContactChk');
        if (unk) unk.checked = false;
      }

      window.addEventListener('load', function() {
        initTheme();
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéƒ½é“åºœçœŒã‚’æ ƒæœ¨çœŒã«è¨­å®šã—ã¦ã‹ã‚‰å€™è£œã‚’èª­ã¿è¾¼ã¿
        try {
          const p = document.getElementById('facilityPref'); if (p && !p.value) p.value = 'æ ƒæœ¨çœŒ';
        } catch(e){}
        onFacilityPrefChange();
        loadEmployeesForReporter();
        document.getElementById('reportFacility').addEventListener('change', function() {
          loadReports(this.value);
          loadContactsForFacility(this.value);
          rebuildNextActionOptions();
          showSelectedFacilityDescription();
        });
          document.getElementById('contactSelect').addEventListener('change', showSelectedContactNotes);
        document.getElementById('channelSelect').addEventListener('change', function(){
          if (this.value === 'ãã®ä»–') {
            document.getElementById('channelOtherWrap').style.display = 'block';
          } else {
            document.getElementById('channelOtherWrap').style.display = 'none';
            document.getElementById('channelOther').value = '';
          }
        });
        document.getElementById('statusStage').addEventListener('change', function(){
          rebuildNextActionOptions();
        });
        document.getElementById('nextActionSelect').addEventListener('change', function(){
          if (this.value === 'ãã®ä»–') {
            document.getElementById('nextActionManualWrap').style.display = 'block';
          } else {
            document.getElementById('nextActionManualWrap').style.display = 'none';
            document.getElementById('nextActionManual').value = '';
          }
        });
        rebuildNextActionOptions();
      });

      // å–¶æ¥­å ±å‘Šç”»é¢ã‹ã‚‰æ‹…å½“è€…ã‚’æ–°è¦è¿½åŠ 
      function addContactFromReport() {
        const facilityId = document.getElementById('reportFacility').value;
        if (!facilityId) { alert('å…ˆã«æ–½è¨­ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        const name = document.getElementById('newContactName').value.trim();
        const phone = document.getElementById('newContactPhone').value.trim();
        const notes = document.getElementById('newContactNotes').value.trim();
        if (!name) { alert('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¸æ˜ã®å ´åˆã¯ä¸Šã®ãƒã‚§ãƒƒã‚¯ã‚’ä½¿ãˆã¾ã™ï¼‰'); return; }
        const fileInput = document.getElementById('newContactCardFile');
        const hasFile = fileInput && fileInput.files && fileInput.files[0];
        google.script.run.withSuccessHandler(function(res){
          const newId = res && res.id;
          const afterReload = function(){
            toggleNewContactPanel(false);
            resetNewContactPanelFields();
            loadContactsForFacility(facilityId, newId);
          };
          if (hasFile && newId) {
            const reader = new FileReader();
            reader.onload = function(ev){
              google.script.run.withSuccessHandler(function(){
                afterReload();
              }).uploadFacilityContactCard({ contactId: newId, dataUrl: ev.target.result });
            };
            reader.readAsDataURL(fileInput.files[0]);
          } else {
            afterReload();
          }
        }).addFacilityContact({ facilityId: facilityId, contactName: name, contactPhone: phone, contactNotes: notes });
      }
      function toggleNewContactPanel(force) {
        const facilityId = document.getElementById('reportFacility').value;
        if (!facilityId) { alert('å…ˆã«æ–½è¨­ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
        const panel = document.getElementById('newContactPanel');
        if (!panel) return;
        if (typeof force === 'boolean') {
          panel.style.display = force ? 'block' : 'none';
        } else {
          panel.style.display = (panel.style.display === 'none' || !panel.style.display) ? 'block' : 'none';
        }
      }
      function resetNewContactPanelFields() {
        const a = id => { const el = document.getElementById(id); if (el) el.value=''; };
        a('newContactName'); a('newContactPhone'); a('newContactNotes'); a('newContactCardFile');
        const wrap = document.getElementById('newContactCardPreviewWrap'); if (wrap) wrap.style.display='none';
        const img = document.getElementById('newContactCardPreview'); if (img) img.src='';
      }
      function previewNewContactCard() {
        const input = document.getElementById('newContactCardFile');
        const wrap = document.getElementById('newContactCardPreviewWrap');
        const img = document.getElementById('newContactCardPreview');
        if (!input || !input.files || !input.files[0]) { if (wrap) wrap.style.display='none'; return; }
        const reader = new FileReader();
        reader.onload = function(e){ if (img) img.src = e.target.result; if (wrap) wrap.style.display='block'; };
        reader.readAsDataURL(input.files[0]);
      }

      // æ—¢å­˜ã®å–¶æ¥­å ±å‘Šã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã¸å€¤ã‚’ã‚³ãƒ”ãƒ¼
      function copyReport(id) {
        const r = REPORT_CACHE && REPORT_CACHE[id];
        if (!r) { alert('ã‚³ãƒ”ãƒ¼å¯¾è±¡ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
        // ãƒãƒ£ãƒ³ãƒãƒ«
        const chSel = document.getElementById('channelSelect');
        if (r.channel && chSel) {
          if (String(r.channel).startsWith('ãã®ä»–:')) {
            chSel.value = 'ãã®ä»–';
            document.getElementById('channelOtherWrap').style.display = 'block';
            document.getElementById('channelOther').value = String(r.channel).replace(/^ãã®ä»–:/,'');
          } else {
            chSel.value = r.channel;
            document.getElementById('channelOtherWrap').style.display = 'none';
            document.getElementById('channelOther').value = '';
          }
        }
        // æ‹…å½“è€…
        const contactSel = document.getElementById('contactSelect');
        const unknownChk = document.getElementById('unknownContactChk');
        if (unknownChk) unknownChk.checked = (r.contactName === 'ä¸æ˜');
        if (contactSel && !unknownChk.checked) {
          let set = false;
          if (r.contactId) {
            contactSel.value = r.contactId;
            set = (contactSel.value === r.contactId);
          }
          if (!set && r.contactName) {
            for (let i=0;i<contactSel.options.length;i++) {
              if (contactSel.options[i].text === r.contactName) { contactSel.selectedIndex = i; set = true; break; }
            }
          }
          if (!set) contactSel.selectedIndex = 0;
          showSelectedContactNotes();
        }
        // å ±å‘Šè€…ï¼ˆç¤¾å“¡ï¼‰
        const repSel = document.getElementById('reporterSelect');
        if (repSel && r.reporterName) {
          for (let i=0;i<repSel.options.length;i++) {
            if (repSel.options[i].text === r.reporterName) { repSel.selectedIndex = i; break; }
          }
        }
        // è¦ç´„ãƒ»è©³ç´°ãƒ»ãƒ•ã‚©ãƒ­ãƒ¼
        document.getElementById('summary').value = r.summary || '';
        document.getElementById('details').value = r.details || '';
        document.getElementById('followUp').value = r.followUp || '';
        // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ»å„ªå…ˆåº¦ãƒ»ã‚ªãƒ¼ãƒŠãƒ¼ãƒ»ãƒªãƒã‚¤ãƒ³ãƒ‰
        const stSel = document.getElementById('statusStage');
        if (stSel) {
          stSel.value = r.statusStage || '';
          rebuildNextActionOptions(); // ã‚¹ãƒ†ãƒ¼ã‚¸ã«åˆã‚ã›ã¦å€™è£œã‚’æ›´æ–°
        }
        const ownerSel = document.getElementById('nextActionOwner');
        if (ownerSel) {
          if (r.nextActionOwner) {
            for (let i=0;i<ownerSel.options.length;i++) {
              if (ownerSel.options[i].text === r.nextActionOwner) { ownerSel.selectedIndex = i; break; }
            }
          } else {
            ownerSel.selectedIndex = 0;
          }
        }
        const prSel = document.getElementById('priority');
        if (prSel) prSel.value = r.priority || '';
        const rem = document.getElementById('reminderFlag');
        if (rem) rem.checked = !!(r.reminderFlag);
        // æ¬¡ã«ã‚„ã‚‹ã“ã¨
        const naSel = document.getElementById('nextActionSelect');
        const naManualWrap = document.getElementById('nextActionManualWrap');
        const naManual = document.getElementById('nextActionManual');
        let next = r.nextAction || '';
        if (naSel) {
          let selected = false;
          if (next && !String(next).startsWith('ãã®ä»–:')) {
            // å€™è£œã«ã‚ã‚Œã°ãã‚Œã‚’é¸ã¶
            for (let i=0;i<naSel.options.length;i++) {
              if (naSel.options[i].value === next) { naSel.selectedIndex = i; selected = true; break; }
            }
          }
          if (!selected) {
            // ãã®ä»–ã§å…¥åŠ›
            naSel.value = 'ãã®ä»–';
            if (naManualWrap) naManualWrap.style.display = 'block';
            if (naManual) naManual.value = String(next).replace(/^ãã®ä»–:/,'');
          } else {
            if (naManualWrap) naManualWrap.style.display = 'none';
            if (naManual) naManual.value = '';
          }
        }
        // æ¬¡å›äºˆå®šæ—¥ã¯ã‚³ãƒ”ãƒ¼ï¼ˆå¿…è¦ã«å¿œã˜ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª¿æ•´ï¼‰
        document.getElementById('nextActionDate').value = r.nextActionDate || '';
        // å ±å‘Šæ—¥æ™‚ã¯ç¾åœ¨æ™‚åˆ»ã‚’è‡ªå‹•ã‚»ãƒƒãƒˆ
        document.getElementById('reportDate').value = nowForDatetimeLocal();
        // ä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ç·¨é›†ã«ç§»ã‚Šã‚„ã™ã
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      // ç›´è¿‘5ä»¶ã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆã‚’ã‚«ãƒ¼ãƒ‰ã§è¡¨ç¤º
      function renderRecentDigest(list) {
        const wrap = document.getElementById('recentDigest');
        if (!wrap) return;
        if (!list || list.length === 0) { wrap.innerHTML = ''; return; }
        const five = list.slice(0,5);
        let html = '<div class="muted" style="margin-bottom:4px;">æœ€è¿‘ã®å ±å‘Šï¼ˆ5ä»¶ï¼‰</div><div class="digest-cards">';
        five.forEach(function(r){
          const dstr = (r.reportDate || r.createdAt) ? new Date(r.reportDate || r.createdAt).toLocaleString() : '';
          html += '<div class="digest-card">'
                + '<div class="title">' + escapeHtml(r.summary || '(ç„¡é¡Œ)') + '</div>'
                + '<div class="meta">' + escapeHtml(dstr) + ' / ' + escapeHtml(r.channel || '') + (r.contactName? (' / ' + escapeHtml(r.contactName)) : '') + '</div>'
                + (r.nextAction ? ('<div class="muted">æ¬¡: ' + escapeHtml(r.nextAction) + (r.nextActionDate? ('ï¼ˆ' + escapeHtml(r.nextActionDate) + 'ï¼‰') : '') + '</div>') : '')
                + '<div style="margin-top:6px;"><button type="button" style="padding:4px 8px;font-size:12px;" onclick="copyReport(\'' + String(r.id).replace(/'/g,"&#39;") + '\')">ã‚³ãƒ”ãƒ¼</button></div>'
                + '</div>';
        });
        html += '</div>';
        wrap.innerHTML = html;
      }

      // æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å€™è£œãƒã‚¹ã‚¿ãƒ¼ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸åŸºç¤ï¼‰
      const NEXT_ACTION_BASE = {
        'æ–°è¦æ¥è§¦': ['ç¦ç¥‰ã‚µãƒ¼ãƒ“ã‚¹æ¡ˆå†…è³‡æ–™é€ä»˜','ã‚±ã‚¢ãƒãƒé¢è«‡èª¿æ•´','å°å…¥æ”¯æ´ã®å„ªå…ˆäº‹é …ãƒ’ã‚¢ãƒªãƒ³ã‚°','æ–½è¨­è¦‹å­¦ãƒ»ä½“é¨“æ—¥ç¨‹èª¿æ•´'],
        'ç¶™ç¶šäº¤æ¸‰': ['æ”¯æ´ä½“åˆ¶ç¢ºèªãƒ•ã‚©ãƒ­ãƒ¼','æ‹…å½“è€…ç´¹ä»‹è³‡æ–™å†é€','æ”¯æ´æ–¹é‡èª¿æ•´æ‰“ã¡åˆã‚ã›','å¿…è¦æ›¸é¡ã®æ¡ˆå†…'],
        'è¦‹ç©ãƒ»ææ¡ˆä¸­': ['äº‹æ¥­æ‰€åˆ¥è²»ç”¨è¦‹ç©é€ä»˜','åŠ ç®—è¦ä»¶ç¢ºèª','å°å…¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«èª¿æ•´','æ”¯æ´è¨ˆç”»æ¡ˆãƒ¬ãƒ“ãƒ¥ãƒ¼'],
        'æ„æ€æ±ºå®šå¾…ã¡': ['é–¢ä¿‚æ©Ÿé–¢ã¸ã®æƒ…å ±å…±æœ‰','å°å…¥æº–å‚™æ¡ˆã®å†ç¢ºèª','æ–½è¨­é•·ãƒ»ã‚±ã‚¢ãƒãƒã¸ã®å†ãƒ•ã‚©ãƒ­ãƒ¼'],
        'å—æ³¨': ['å°å…¥èª¬æ˜ä¼šã®èª¿æ•´','å¥‘ç´„æ›¸ãƒ»åŒæ„æ›¸ã®æ•´ç†','ã‚¹ã‚¿ãƒƒãƒ•å‘ã‘èª¬æ˜è³‡æ–™é€ä»˜','åˆå›è¨ªå•ã‚µãƒãƒ¼ãƒˆ'],
        'å¤±æ³¨': ['ç†ç”±ãƒ’ã‚¢ãƒªãƒ³ã‚°','å€™è£œè€…æƒ…å ±ã®è¨˜éŒ²','æ¬¡ã®å†æ¥è§¦å€™è£œã¨ã—ã¦ãƒªã‚¹ãƒˆåŒ–']
      };
      // æ–½è¨­ç¨®é¡åˆ¥ã®è¿½åŠ å€™è£œ
      const NEXT_ACTION_EXTRA = {
        'å…±åŒç”Ÿæ´»æ´åŠ©ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ ï¼‰': {
          'æ–°è¦æ¥è§¦': ['ç©ºå®¤çŠ¶æ³ç¢ºèª','ä¸–è©±äººé¢è«‡èª¿æ•´'],
          'ç¶™ç¶šäº¤æ¸‰': ['å…¥å±…å€™è£œè€…æƒ…å ±å…±æœ‰','å¤œé–“ä½“åˆ¶ãƒ’ã‚¢ãƒªãƒ³ã‚°'],
          'è¦‹ç©ãƒ»ææ¡ˆä¸­': ['åŠ ç®—è¦ä»¶ç¢ºèª','å€‹åˆ¥æ”¯æ´è¨ˆç”»é€£æºç›¸è«‡']
        },
        'è¨ªå•çœ‹è­·': {
          'æ–°è¦æ¥è§¦': ['ç–¾æ‚£åˆ¥åˆ©ç”¨çŠ¶æ³ç¢ºèª','ã‚±ã‚¢ãƒãƒç´¹ä»‹ä¾é ¼'],
          'ç¶™ç¶šäº¤æ¸‰': ['çœ‹è­·å¸«ä½“åˆ¶ç¢ºèª','ä»–è·ç¨®é€£æºäº‹ä¾‹ç´¹ä»‹'],
          'è¦‹ç©ãƒ»ææ¡ˆä¸­': ['åŒ»ç™‚å‡¦ç½®ç¯„å›²ç¢ºèª','æŒ‡ç¤ºæ›¸é‹ç”¨ç¢ºèª']
        }
      };
      function rebuildNextActionOptions() {
        const stage = document.getElementById('statusStage').value;
        const facilitySel = document.getElementById('reportFacility');
        let facilityType = '';
        if (facilitySel && facilitySel.value) {
          const opt = facilitySel.options[facilitySel.selectedIndex];
          facilityType = opt ? (opt.getAttribute('data-facility-type') || '') : '';
        }
        const sel = document.getElementById('nextActionSelect');
        if (!sel) return;
        const actions = [];
        if (stage && NEXT_ACTION_BASE[stage]) {
          actions.push(...NEXT_ACTION_BASE[stage]);
        }
        if (stage && facilityType && NEXT_ACTION_EXTRA[facilityType] && NEXT_ACTION_EXTRA[facilityType][stage]) {
          actions.push(...NEXT_ACTION_EXTRA[facilityType][stage]);
        }
        // é‡è¤‡æ’é™¤
        const uniq = [];
        const seen = new Set();
        actions.forEach(a => { if (!seen.has(a)) { seen.add(a); uniq.push(a); } });
        sel.innerHTML = '<option value="">-- æ¬¡ã«ã‚„ã‚‹ã“ã¨ã‚’é¸æŠ (ä»»æ„) --</option>';
        uniq.forEach(a => {
          const o = document.createElement('option'); o.value = a; o.textContent = a; sel.appendChild(o);
        });
        // ãã®ä»–é¸æŠè‚¢
        const oOther = document.createElement('option'); oOther.value = 'ãã®ä»–'; oOther.textContent = 'ãã®ä»–'; sel.appendChild(oOther);
        document.getElementById('nextActionManualWrap').style.display = 'none';
        document.getElementById('nextActionManual').value = '';
      }
      function resetNextActionSelect() {
        const sel = document.getElementById('nextActionSelect');
        if (sel) sel.selectedIndex = 0;
        document.getElementById('nextActionManualWrap').style.display = 'none';
        document.getElementById('nextActionManual').value = '';
      }
    </script>
  </head>
  <body>
    <nav class="fullbleed">
      <!-- çµ¶å¯¾URLåŒ–ã§ iframe / ç›¸å¯¾ãƒªãƒ³ã‚¯ã® /blank å•é¡Œã‚’å›é¿ -->
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=index">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=facilities">æ–½è¨­ç™»éŒ²</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=visits">å•ã„åˆã‚ã›è¨˜éŒ²</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=employees">ç¤¾å“¡ç™»éŒ²</a>
  <button id="themeToggleBtn" type="button" onclick="toggleTheme()" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ“</button>
    </nav>

    <h1>å–¶æ¥­å ±å‘Š</h1>
    <form id="reportForm" onsubmit="event.preventDefault(); submitReport();">
      <label for="reportFacility">æ–½è¨­</label>
      <div style="border:1px solid #eee; padding:10px; border-radius:6px; margin-bottom:8px;">
        <div class="grid3">
          <div>
            <label for="facilityPref" style="margin-top:0;">éƒ½é“åºœçœŒ</label>
            <select id="facilityPref" onchange="onFacilityPrefChange()">
              <option value="">å…¨ã¦</option>
              <option>æ±äº¬éƒ½</option><option>ç¥å¥ˆå·çœŒ</option><option>åƒè‘‰çœŒ</option><option>åŸ¼ç‰çœŒ</option><option>èŒ¨åŸçœŒ</option><option selected>æ ƒæœ¨çœŒ</option><option>ç¾¤é¦¬çœŒ</option><option>å±±æ¢¨çœŒ</option>
            </select>
          </div>
          <div>
            <label for="facilityMun" style="margin-top:0;">å¸‚åŒºç”ºæ‘</label>
            <select id="facilityMun" onchange="updateFacilityOptions()"><option value="">å…¨ã¦</option></select>
          </div>
          <div>
            <label for="facilityTypeFilter" style="margin-top:0;">äº‹æ¥­æ‰€ç¨®é¡</label>
            <select id="facilityTypeFilter" onchange="updateFacilityOptions()">
              <option value="">å…¨ã¦</option>
              <optgroup label="é«˜é½¢è€…ç³»">
                <option value="å±…å®…ä»‹è­·æ”¯æ´">å±…å®…ä»‹è­·æ”¯æ´</option>
                <option value="è¨ªå•ä»‹è­·">è¨ªå•ä»‹è­·</option>
                <option value="é€šæ‰€ä»‹è­·">é€šæ‰€ä»‹è­·</option>
                <option value="è¨ªå•çœ‹è­·">è¨ªå•çœ‹è­·</option>
                <option value="çœ‹è­·å°è¦æ¨¡å¤šæ©Ÿèƒ½">çœ‹è­·å°è¦æ¨¡å¤šæ©Ÿèƒ½</option>
                <option value="ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ">ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ </option>
                <option value="æœ‰æ–™è€äººãƒ›ãƒ¼ãƒ ">æœ‰æ–™è€äººãƒ›ãƒ¼ãƒ </option>
                <option value="ã‚µãƒ¼ãƒ“ã‚¹ä»˜é«˜é½¢è€…ä½å®…">ã‚µãƒ¼ãƒ“ã‚¹ä»˜é«˜é½¢è€…ä½å®…</option>
              </optgroup>
              <optgroup label="éšœå®³ç¦ç¥‰ï¼ˆæˆäººï¼‰">
                <option value="å°±åŠ´ç§»è¡Œæ”¯æ´">å°±åŠ´ç§»è¡Œæ”¯æ´</option>
                <option value="å°±åŠ´ç¶™ç¶šæ”¯æ´Aå‹">å°±åŠ´ç¶™ç¶šæ”¯æ´Aå‹</option>
                <option value="å°±åŠ´ç¶™ç¶šæ”¯æ´Bå‹">å°±åŠ´ç¶™ç¶šæ”¯æ´Bå‹</option>
                <option value="å°±åŠ´å®šç€æ”¯æ´">å°±åŠ´å®šç€æ”¯æ´</option>
                <option value="ç”Ÿæ´»ä»‹è­·">ç”Ÿæ´»ä»‹è­·</option>
                <option value="è‡ªç«‹è¨“ç·´ï¼ˆç”Ÿæ´»è¨“ç·´ï¼‰">è‡ªç«‹è¨“ç·´ï¼ˆç”Ÿæ´»è¨“ç·´ï¼‰</option>
                <option value="è‡ªç«‹è¨“ç·´ï¼ˆæ©Ÿèƒ½è¨“ç·´ï¼‰">è‡ªç«‹è¨“ç·´ï¼ˆæ©Ÿèƒ½è¨“ç·´ï¼‰</option>
                <option value="å…±åŒç”Ÿæ´»æ´åŠ©ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ ï¼‰">å…±åŒç”Ÿæ´»æ´åŠ©ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒ›ãƒ¼ãƒ ï¼‰</option>
                <option value="çŸ­æœŸå…¥æ‰€ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ï¼‰">çŸ­æœŸå…¥æ‰€ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚¹ãƒ†ã‚¤ï¼‰</option>
                <option value="å±…å®…ä»‹è­·ï¼ˆéšœå®³ï¼‰">å±…å®…ä»‹è­·ï¼ˆéšœå®³ï¼‰</option>
                <option value="é‡åº¦è¨ªå•ä»‹è­·">é‡åº¦è¨ªå•ä»‹è­·</option>
                <option value="åŒè¡Œæ´è­·">åŒè¡Œæ´è­·</option>
                <option value="è¡Œå‹•æ´è­·">è¡Œå‹•æ´è­·</option>
                <option value="ç§»å‹•æ”¯æ´">ç§»å‹•æ”¯æ´</option>
                <option value="æ–½è¨­å…¥æ‰€æ”¯æ´">æ–½è¨­å…¥æ‰€æ”¯æ´</option>
              </optgroup>
              <optgroup label="ç›¸è«‡æ”¯æ´">
                <option value="ç‰¹å®šç›¸è«‡æ”¯æ´ï¼ˆè¨ˆç”»ç›¸è«‡ï¼‰">ç‰¹å®šç›¸è«‡æ”¯æ´ï¼ˆè¨ˆç”»ç›¸è«‡ï¼‰</option>
                <option value="éšœå®³å…ç›¸è«‡æ”¯æ´">éšœå®³å…ç›¸è«‡æ”¯æ´</option>
              </optgroup>
              <optgroup label="å…ç«¥ãƒ»ç™‚è‚²">
                <option value="å…ç«¥ç™ºé”æ”¯æ´">å…ç«¥ç™ºé”æ”¯æ´</option>
                <option value="æ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹">æ”¾èª²å¾Œç­‰ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹</option>
                <option value="ä¿è‚²æ‰€ç­‰è¨ªå•æ”¯æ´">ä¿è‚²æ‰€ç­‰è¨ªå•æ”¯æ´</option>
                <option value="å…ç«¥ç™ºé”æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼">å…ç«¥ç™ºé”æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼</option>
              </optgroup>
              <optgroup label="ãã®ä»–ãƒ»é–¢é€£æ©Ÿé–¢">
                <option value="ã‚±ã‚¢ãƒãƒ">ã‚±ã‚¢ãƒãƒ</option>
                <option value="åŒ»ç™‚æ©Ÿé–¢">åŒ»ç™‚æ©Ÿé–¢</option>
                <option value="å¸‚å½¹æ‰€">å¸‚å½¹æ‰€</option>
                <option value="è¡Œæ”¿æ©Ÿé–¢">è¡Œæ”¿æ©Ÿé–¢</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
              </optgroup>
            </select>
          </div>
        </div>
        <div class="action-row fullbleed">
          <input id="facilityKw" type="text" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆåç§°/ä½æ‰€/å‚™è€ƒï¼‰" oninput="updateFacilityOptionsDebounced()">
          <button type="button" onclick="updateFacilityOptions()">å€™è£œã‚’æ›´æ–°</button>
        </div>
      </div>
  <select id="reportFacility" required></select>
  <div class="muted" id="facilityDescBox" style="margin-top:4px; font-size:13px;"></div>
  <div class="muted" id="activityBox" style="margin-top:4px;"></div>
  <div id="recentDigest" class="digest-wrap"></div>
      <label for="reportDate">å ±å‘Šæ—¥æ™‚</label>
      <input type="datetime-local" id="reportDate">
      <label for="channelSelect">å ±å‘Šæ–¹æ³•</label>
      <select id="channelSelect" required>
        <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
        <option value="è¨ªå•">è¨ªå•</option>
        <option value="é›»è©±">é›»è©±</option>
        <option value="åˆ©ç”¨è€…é€è¿">åˆ©ç”¨è€…é€è¿</option>
        <option value="FAX">FAX</option>
        <option value="ãƒ¡ãƒ¼ãƒ«">ãƒ¡ãƒ¼ãƒ«</option>
        <option value="ã‚ªãƒ³ãƒ©ã‚¤ãƒ³">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</option>
        <option value="ãã®ä»–">ãã®ä»–</option>
      </select>
      <div id="channelOtherWrap" style="display:none;">
        <label for="channelOther">ãã®ä»–è©³ç´°</label>
        <input type="text" id="channelOther" placeholder="å…·ä½“çš„ãªæ–¹æ³•ã‚’è¨˜è¼‰">
      </div>
      <label for="contactSelect">å¯¾å¿œæ‹…å½“è€…ï¼ˆæ–½è¨­æ‹…å½“è€…ï¼‰</label>
      <select id="contactSelect" disabled>
        <option value="">-- æ–½è¨­ã‚’å…ˆã«é¸æŠ --</option>
      </select>
      <div style="margin:6px 0 8px;">
        <label style="display:flex; align-items:center; gap:8px; margin:0;">
          <input type="checkbox" id="unknownContactChk">æ‹…å½“è€…ä¸æ˜ï¼ˆåå‰ã‚’ã€ä¸æ˜ã€ã¨ã—ã¦ä¿å­˜ï¼‰
        </label>
      </div>
      <div id="contactInfoBox" style="margin:4px 0 12px; font-size:13px; color:#555;"></div>
      <div id="newContactPanel" style="display:none; border:1px solid #eee; padding:10px; border-radius:6px; margin-bottom:8px;">
        <div style="font-size:13px; color:#555; margin-bottom:6px;">æ‹…å½“è€…ã‚’æ–°è¦è¿½åŠ ï¼ˆã“ã®æ–½è¨­ã«ç´ã¥ãã¾ã™ï¼‰</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          <input id="newContactName" placeholder="æ°åï¼ˆå¿…é ˆï¼‰">
          <input id="newContactPhone" placeholder="é›»è©±">
        </div>
        <input id="newContactNotes" placeholder="å‚™è€ƒ" style="margin-top:8px;">
        <div style="margin-top:8px;">
          <label style="display:block; margin-bottom:4px;">ååˆºå†™çœŸï¼ˆä»»æ„ï¼‰</label>
          <input type="file" id="newContactCardFile" accept="image/*" onchange="previewNewContactCard()">
          <div id="newContactCardPreviewWrap" style="display:none; margin-top:6px;">
            <img id="newContactCardPreview" alt="preview" style="max-width:180px; max-height:140px; border:1px solid #eee;" />
          </div>
        </div>
        <button type="button" onclick="addContactFromReport()" style="margin-top:8px;">æ‹…å½“è€…ã‚’è¿½åŠ </button>
      </div>
      <div class="contact-panel-toggle fullbleed">
        <button type="button" onclick="toggleNewContactPanel()">æ‹…å½“è€…è¿½åŠ ãƒ‘ãƒãƒ«ã‚’é–‹ã / é–‰ã˜ã‚‹</button>
      </div>
      <label for="reporterSelect">å ±å‘Šè€…ï¼ˆç¤¾å“¡ï¼‰</label>
      <select id="reporterSelect" required>
        <option value="">-- èª­ã¿è¾¼ã¿ä¸­ --</option>
      </select>
      <label for="summary">è¦ç´„ï¼ˆå¿…é ˆï¼‰</label>
      <input type="text" id="summary" required>
      <label for="details">è©³ç´°</label>
      <textarea id="details" rows="4"></textarea>
      <label for="followUp">ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ— / æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
      <input type="text" id="followUp">
  <div class="next-action-grid edge-expand">
        <div>
          <label for="nextActionSelect">æ¬¡ã«ã‚„ã‚‹ã“ã¨ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸/ç¨®é¡ã«å¿œã˜å€™è£œï¼‰</label>
          <select id="nextActionSelect"></select>
          <div id="nextActionManualWrap" style="display:none;margin-top:6px;">
            <label for="nextActionManual" style="margin-top:0;">ãã®ä»–è©³ç´°</label>
            <input type="text" id="nextActionManual" placeholder="è‡ªç”±å…¥åŠ›" />
          </div>
        </div>
        <div>
          <label for="nextActionDate">æ¬¡å›äºˆå®šæ—¥</label>
          <input type="date" id="nextActionDate">
        </div>
        <div>
          <label for="nextActionOwner">æ‹…å½“ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ï¼‰</label>
          <select id="nextActionOwner"><option value="">æœªæŒ‡å®š</option></select>
          <div class="muted" style="font-size:13px; margin-top:4px;">è‡ªç¤¾ã®å–¶æ¥­ãƒ¡ãƒ³ãƒãƒ¼ã‚„æ‹…å½“è€…ã‚’é¸ã³ã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è²¬ä»»è€…ã¨ã—ã¦è¨˜éŒ²ã—ã¾ã™ã€‚</div>
        </div>
        <div>
          <label for="priority">å„ªå…ˆåº¦</label>
          <select id="priority">
            <option value="">æœªè¨­å®š</option>
            <option value="é«˜">é«˜</option>
            <option value="ä¸­">ä¸­</option>
            <option value="ä½">ä½</option>
          </select>
        </div>
        <div>
          <label for="statusStage">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <select id="statusStage">
            <option value="">æœªè¨­å®š</option>
            <option value="æ–°è¦æ¥è§¦">æ–°è¦æ¥è§¦</option>
            <option value="ç¶™ç¶šäº¤æ¸‰">ç¶™ç¶šäº¤æ¸‰</option>
            <option value="è¦‹ç©ãƒ»ææ¡ˆä¸­">è¦‹ç©ãƒ»ææ¡ˆä¸­</option>
            <option value="æ„æ€æ±ºå®šå¾…ã¡">æ„æ€æ±ºå®šå¾…ã¡</option>
            <option value="å—æ³¨">å—æ³¨</option>
            <option value="å¤±æ³¨">å¤±æ³¨</option>
          </select>
          <details style="margin-top:4px;font-size:12px;color:#555;">
            <summary>ã‚¹ãƒ†ãƒ¼ã‚¸ã®ç›®å®‰</summary>
            <div style="padding:4px 0;line-height:1.4;">
              <b>æ–°è¦æ¥è§¦</b>: åˆå›ã¾ãŸã¯æƒ…å ±åé›†æ®µéš / <b>ç¶™ç¶šäº¤æ¸‰</b>: å…·ä½“çš„ãªãƒ‹ãƒ¼ã‚ºãƒ»èª²é¡Œãƒ’ã‚¢ãƒªãƒ³ã‚°é€²è¡Œä¸­<br>
              <b>è¦‹ç©ãƒ»ææ¡ˆä¸­</b>: é‡‘é¡/ææ¡ˆè³‡æ–™æç¤ºæ¸ˆã¿ / <b>æ„æ€æ±ºå®šå¾…ã¡</b>: ç¤¾å†…æ¤œè¨ãƒ»æ‰¿èªå¾…ã¡<br>
              <b>å—æ³¨</b>: å¥‘ç´„ãƒ»å°å…¥ç¢ºå®š / <b>å¤±æ³¨</b>: è¦‹é€ã‚Šç†ç”±ç¢ºå®šï¼ˆç†ç”±ãƒ’ã‚¢ãƒªãƒ³ã‚°æ¨å¥¨ï¼‰
            </div>
          </details>
        </div>
        <div style="display:flex; align-items:center; gap:8px; margin-top:22px;">
          <input type="checkbox" id="reminderFlag">
          <label for="reminderFlag" style="margin:0;">ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼ˆè¦ãƒ•ã‚©ãƒ­ãƒ¼ï¼‰</label>
        </div>
      </div>
  <div class="fullbleed edge-expand">
        <button type="submit">å–¶æ¥­å ±å‘Šã‚’ç™»éŒ²</button>
      </div>
    </form>

    <h2>æ–½è¨­åˆ¥ã®å–¶æ¥­å ±å‘Š</h2>
    <div class="table-wrap">
    <table>
      <thead>
        <tr><th>å ±å‘Šæ—¥æ™‚</th><th>æ–¹æ³•</th><th>è¦ç´„</th><th>æ‹…å½“è€…</th><th>å ±å‘Šè€…</th><th>è©³ç´° / ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—</th></tr>
      </thead>
      <tbody id="reportRows">
        <tr><td colspan="6">æ–½è¨­ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>
      </tbody>
    </table>
    </div>
  </body>
</html>
