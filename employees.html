<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      :root { color-scheme: light dark; }
      *, *::before, *::after { box-sizing: border-box; }
      html, body { width:100%; max-width:100%; overflow-x:hidden; }
  body { font-family: Arial, sans-serif; padding: 24px; margin: 0; }
      nav { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
      nav a { margin-right: 12px; }
      /* compact floating theme toggle (icon) */
      #themeToggleBtn {
        width:44px; height:44px; display:flex; align-items:center; justify-content:center;
        position:fixed; top:12px; right:12px; z-index:9999;
        border-radius:999px; border:1px solid rgba(12,102,212,0.12);
        background:#fff; color:#0c66d4; box-shadow:0 2px 6px rgba(0,0,0,0.08); cursor:pointer;
        font-size:18px; line-height:1;
      }
      #themeToggleBtn:hover { transform:scale(1.06); }
      label { display: block; margin-top: 12px; }
      input, select { width: 100%; padding: 6px; }
      button { margin-top: 16px; padding: 8px 16px; }
  .table-wrap { width:100%; overflow-x:auto; -webkit-overflow-scrolling: touch; }
      table { width: 100%; border-collapse: collapse; margin-top: 24px; min-width: 560px; }
      th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
      h2 { margin-top: 28px; }
  @media (max-width: 640px) { body { padding:16px; } input, select { font-size:18px; } button { padding:12px 16px; min-height:clamp(48px,8vh,64px); font-size:clamp(16px, 2.8vw + 12px, 20px); width:100%; border-radius:10px; } }
      /* Mobile: stack nav vertically and make full-width buttons */
      @media (max-width: 650px) {
        nav { flex-direction: column; align-items: stretch; }
        nav a, nav button { width: 100%; margin: 0 0 8px 0; border-radius: 10px; min-height: clamp(56px,10vh,72px); font-size: clamp(16px, 2.8vw + 12px, 20px); padding: clamp(14px,2vh,18px) 18px; }
  nav a { margin-right: 0; }
      }
      @media (prefers-color-scheme: dark) {
        body { background:#111; color:#eaeaea; }
        th, td { border-bottom:1px solid #333; }
        input, select { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
        button { background:#2a2a2a; color:#eaeaea; border:1px solid #444; }
      }
      body.theme-dark { background:#111; color:#eaeaea; }
      body.theme-dark th, body.theme-dark td { border-bottom:1px solid #333; }
      body.theme-dark input, body.theme-dark select { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
      body.theme-dark button { background:#2a2a2a; color:#eaeaea; border:1px solid #444; }
      body.theme-light { background:#fff; color:#111; }
      body.theme-dark #themeToggleBtn { background:#1a1a1a; color:#8ab4ff; border-color:#3769e6; }
      body.theme-dark #themeToggleBtn:hover { background:#1f3a75; color:#eaeaea; }
    </style>
    <script>
  function applyTheme(pref){ document.body.classList.remove('theme-dark','theme-light'); if(pref==='dark')document.body.classList.add('theme-dark'); if(pref==='light')document.body.classList.add('theme-light'); }
  function updateThemeButton(pref){ const b=document.getElementById('themeToggleBtn'); if(!b) return; if(pref==='dark'){ b.innerHTML='ğŸŒ™'; b.title='ãƒ†ãƒ¼ãƒ: ãƒ€ãƒ¼ã‚¯'; b.setAttribute('aria-label','ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰'); } else if(pref==='light'){ b.innerHTML='â˜€ï¸'; b.title='ãƒ†ãƒ¼ãƒ: ãƒ©ã‚¤ãƒˆ'; b.setAttribute('aria-label','ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰'); } else { b.innerHTML='ğŸŒ“'; b.title='ãƒ†ãƒ¼ãƒ: è‡ªå‹•'; b.setAttribute('aria-label','ãƒ†ãƒ¼ãƒ: è‡ªå‹•'); } }
      function initTheme(){ const p=localStorage.getItem('theme')||'system'; applyTheme(p); updateThemeButton(p); }
      function toggleTheme(){ const cur=localStorage.getItem('theme')||'system'; const next=cur==='system'?'dark':(cur==='dark'?'light':'system'); localStorage.setItem('theme',next); applyTheme(next); updateThemeButton(next); }
      let submitting = false;
      function submitEmployee() {
        if (submitting) return; // å¤šé‡é€ä¿¡é˜²æ­¢
        const data = {
          name: document.getElementById('employeeName').value.trim(),
          phone: document.getElementById('employeePhone').value.trim(),
          role: document.getElementById('employeeRole').value.trim(),
          email: '' // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰äº’æ›ç”¨ï¼ˆå‰Šé™¤äºˆå®šåˆ—ï¼‰
        };
        if (!data.name) { alert('æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        submitting = true;
        const btn = document.getElementById('employeeSubmitBtn');
        if (btn) btn.disabled = true;
        google.script.run.withSuccessHandler(function(res) {
          alert('ç¤¾å“¡æƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã—ãŸ (ID: ' + (res && res.id ? res.id : 'æ—¢å­˜') + ')');
          document.getElementById('employeeForm').reset();
          submitting = false;
          if (btn) btn.disabled = false;
          loadEmployees();
        }).withFailureHandler(function(err){
          alert('ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ' + (err && err.message ? err.message : err));
          submitting = false;
          if (btn) btn.disabled = false;
        }).addEmployee(data);
      }

      function loadEmployees() {
        google.script.run.withSuccessHandler(function(list) {
          const tbody = document.getElementById('employeeRows');
          if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4">ç™»éŒ²ã•ã‚ŒãŸç¤¾å“¡ã¯ã„ã¾ã›ã‚“</td></tr>';
            return;
          }
          let html = '';
          list.forEach(function(emp) {
            const id = escapeHtml(emp.id);
            const name = escapeHtml(emp.name);
            const phone = escapeHtml(emp.phone || '');
            const role = escapeHtml(emp.role || '');
            html += '<tr data-id="' + id + '">' +
              '<td>' +
                '<span class="view name">' + name + '</span>' +
                '<input class="edit name" type="text" value="' + name + '" style="display:none;width:100%" />' +
              '</td>' +
              '<td>' +
                '<span class="view phone">' + phone + '</span>' +
                '<input class="edit phone" type="text" value="' + phone + '" style="display:none;width:100%" />' +
              '</td>' +
              '<td>' +
                '<span class="view role">' + role + '</span>' +
                '<input class="edit role" type="text" value="' + role + '" style="display:none;width:100%" />' +
              '</td>' +
              '<td>' +
                '<button type="button" class="editBtn">ç·¨é›†</button>' +
                '<button type="button" class="saveBtn" style="display:none">ä¿å­˜</button>' +
                '<button type="button" class="cancelBtn" style="display:none">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>' +
                '<button type="button" class="deleteBtn" style="margin-left:8px;color:#fff;background:#c0392b">å‰Šé™¤</button>' +
              '</td>' +
            '</tr>';
          });
          tbody.innerHTML = html;
          bindRowEvents();
        }).getEmployees();
      }

      function bindRowEvents() {
        const tbody = document.getElementById('employeeRows');
        tbody.querySelectorAll('.editBtn').forEach(btn => {
          btn.addEventListener('click', () => enterEdit(btn.closest('tr')));
        });
        tbody.querySelectorAll('.cancelBtn').forEach(btn => {
          btn.addEventListener('click', () => cancelEdit(btn.closest('tr')));
        });
        tbody.querySelectorAll('.saveBtn').forEach(btn => {
          btn.addEventListener('click', () => saveRow(btn.closest('tr')));
        });
        tbody.querySelectorAll('.deleteBtn').forEach(btn => {
          btn.addEventListener('click', () => deleteRow(btn.closest('tr')));
        });
      }

      function enterEdit(tr) {
        tr.querySelectorAll('.view').forEach(el => el.style.display = 'none');
        tr.querySelectorAll('.edit').forEach(el => el.style.display = 'block');
        tr.querySelector('.editBtn').style.display = 'none';
        tr.querySelector('.saveBtn').style.display = 'inline-block';
        tr.querySelector('.cancelBtn').style.display = 'inline-block';
      }

      function cancelEdit(tr) {
        tr.querySelectorAll('.view').forEach(el => el.style.display = '');
        tr.querySelectorAll('.edit').forEach(el => el.style.display = 'none');
        tr.querySelector('.editBtn').style.display = 'inline-block';
        tr.querySelector('.saveBtn').style.display = 'none';
        tr.querySelector('.cancelBtn').style.display = 'none';
      }

      function saveRow(tr) {
        if (!tr) return;
        const id = tr.getAttribute('data-id');
        const name = tr.querySelector('input.edit.name').value.trim();
        const phone = tr.querySelector('input.edit.phone').value.trim();
        const role = tr.querySelector('input.edit.role').value.trim();
        if (!name) { alert('æ°åã¯å¿…é ˆã§ã™'); return; }
        const saveBtn = tr.querySelector('.saveBtn');
        saveBtn.disabled = true;
        google.script.run.withSuccessHandler(() => {
          cancelEdit(tr);
          loadEmployees();
        }).withFailureHandler(err => {
          alert('æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + (err && err.message ? err.message : err));
          saveBtn.disabled = false;
        }).updateEmployee({ id, name, phone, role, email: '' });
      }

      function deleteRow(tr) {
        if (!tr) return;
        const id = tr.getAttribute('data-id');
        if (!confirm('å‰Šé™¤ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
        const delBtn = tr.querySelector('.deleteBtn');
        delBtn.disabled = true;
        google.script.run.withSuccessHandler(() => {
          loadEmployees();
        }).withFailureHandler(err => {
          alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + (err && err.message ? err.message : err));
          delBtn.disabled = false;
        }).deleteEmployee(id);
      }

      function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }

      window.addEventListener('load', function(){ initTheme(); loadEmployees(); });
    </script>
  </head>
  <body>
    <nav>
      <!-- çµ¶å¯¾URLåŒ–ã§ iframe ç›¸å¯¾ãƒªãƒ³ã‚¯å•é¡Œã‚’å›é¿ -->
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=index">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=facilities">æ–½è¨­ç™»éŒ²</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=visits">å•ã„åˆã‚ã›è¨˜éŒ²</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=reports">å–¶æ¥­å ±å‘Š</a>
  <button id="themeToggleBtn" type="button" onclick="toggleTheme()" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ“</button>
    </nav>

    <h1>ç¤¾å“¡ç™»éŒ²</h1>
    <form id="employeeForm" onsubmit="event.preventDefault(); submitEmployee();">
      <label for="employeeName">æ°å</label>
      <input type="text" id="employeeName" required>
      <label for="employeePhone">é›»è©±ç•ªå·</label>
      <input type="text" id="employeePhone">
      <label for="employeeRole">å½¹å‰²</label>
      <input type="text" id="employeeRole">
  <button type="submit" id="employeeSubmitBtn">ç¤¾å“¡ã‚’ç™»éŒ²</button>
    </form>

    <h2>ç™»éŒ²æ¸ˆã¿ç¤¾å“¡</h2>
    <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th style="width:30%">æ°å</th>
          <th style="width:25%">é›»è©±ç•ªå·</th>
          <th style="width:25%">å½¹å‰²</th>
          <th style="width:20%">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="employeeRows">
        <tr><td colspan="4">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
      </tbody>
    </table>
    </div>
  </body>
</html>
