<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial, sans-serif; padding: 24px; }
      nav a { margin-right: 12px; }
      label { display: block; margin-top: 12px; }
      input, select { width: 100%; padding: 6px; }
      button { margin-top: 16px; padding: 8px 16px; }
      table { width: 100%; border-collapse: collapse; margin-top: 24px; }
      th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
      h2 { margin-top: 28px; }
    </style>
    <script>
      let submitting = false;
      function submitEmployee() {
        if (submitting) return; // 多重送信防止
        const data = {
          name: document.getElementById('employeeName').value.trim(),
          phone: document.getElementById('employeePhone').value.trim(),
          role: document.getElementById('employeeRole').value.trim(),
          email: '' // バックエンド互換用（削除予定列）
        };
        if (!data.name) { alert('氏名を入力してください'); return; }
        submitting = true;
        const btn = document.getElementById('employeeSubmitBtn');
        if (btn) btn.disabled = true;
        google.script.run.withSuccessHandler(function(res) {
          alert('社員情報を登録しました (ID: ' + (res && res.id ? res.id : '既存') + ')');
          document.getElementById('employeeForm').reset();
          submitting = false;
          if (btn) btn.disabled = false;
          loadEmployees();
        }).withFailureHandler(function(err){
          alert('登録エラー: ' + (err && err.message ? err.message : err));
          submitting = false;
          if (btn) btn.disabled = false;
        }).addEmployee(data);
      }

      function loadEmployees() {
        google.script.run.withSuccessHandler(function(list) {
          const tbody = document.getElementById('employeeRows');
          if (!list || list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3">登録された社員はいません</td></tr>';
            return;
          }
            let html = '';
            list.forEach(function(emp) {
              html += '<tr><td>' + escapeHtml(emp.name) + '</td>' +
                      '<td>' + escapeHtml(emp.phone || '') + '</td>' +
                      '<td>' + escapeHtml(emp.role || '') + '</td></tr>';
            });
            tbody.innerHTML = html;
        }).getEmployees();
      }

      function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }

      window.addEventListener('load', loadEmployees);
    </script>
  </head>
  <body>
    <nav>
      <!-- 絶対URL化で iframe 相対リンク問題を回避 -->
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=index">メニューに戻る</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=facilities">施設登録</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=visits">来訪記録</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=reports">営業報告</a>
    </nav>

    <h1>社員登録</h1>
    <form id="employeeForm" onsubmit="event.preventDefault(); submitEmployee();">
      <label for="employeeName">氏名</label>
      <input type="text" id="employeeName" required>
      <label for="employeePhone">電話番号</label>
      <input type="text" id="employeePhone">
      <label for="employeeRole">役割</label>
      <input type="text" id="employeeRole">
  <button type="submit" id="employeeSubmitBtn">社員を登録</button>
    </form>

    <h2>登録済み社員</h2>
    <table>
      <thead>
        <tr><th>氏名</th><th>電話番号</th><th>役割</th></tr>
      </thead>
      <tbody id="employeeRows">
        <tr><td colspan="3">読み込み中...</td></tr>
      </tbody>
    </table>
  </body>
</html>
