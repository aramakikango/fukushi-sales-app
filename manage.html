<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      :root { color-scheme: light dark; }
      *, *::before, *::after { box-sizing: border-box; }
      html, body { width:100%; max-width:100%; overflow-x:hidden; }
  body { font-family: Arial, sans-serif; padding: 24px; margin: 0; }
      nav { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
      nav a { margin-right: 12px; }
      nav #themeToggleBtn { margin-left:auto; }
  /* Theme toggle button base */
  #themeToggleBtn { padding:10px 14px; border:1px solid #0c66d4; background:#fff; color:#0c66d4; border-radius:6px; font-weight:bold; cursor:pointer; }
  #themeToggleBtn:hover { background:#0c66d4; color:#fff; }
      input, select, textarea { padding: 6px; }
  .table-wrap { width:100%; overflow-x:auto; -webkit-overflow-scrolling: touch; }
      table { width: 100%; border-collapse: collapse; margin-top: 16px; min-width: 720px; }
      th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; }
      .row-actions button { margin-right: 6px; }
  .grid { display: grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr); gap: 24px; }
      @media (max-width: 1000px) { .grid { grid-template-columns: 1fr; } }
  @media (max-width: 640px) { body { padding:16px; } .row-actions button { margin-bottom:6px; } input, select, textarea, button { font-size:16px; } button { padding:12px 16px; min-height:44px; } }
      /* Mobile: stack nav vertically and make full-width buttons */
      @media (max-width: 650px) {
        nav { flex-direction: column; align-items: stretch; }
        nav a, nav button { width: 100%; margin: 0 0 8px 0; font-size: 16px; padding: 16px 18px; min-height: 56px; border-radius: 0; }
        nav a { margin-right: 0; }
        #themeToggleBtn { width:100%; }
      }
      .muted { color: #666; font-size: 12px; }
      .flex { display: flex; gap: 8px; align-items: center; }
      @media (prefers-color-scheme: dark) {
        body { background:#111; color:#eaeaea; }
        th, td { border-bottom:1px solid #333; }
        input, select, textarea { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
        button { background:#2a2a2a; color:#eaeaea; border:1px solid #444; }
        .muted { color:#aaa; }
      }
      body.theme-dark { background:#111; color:#eaeaea; }
      body.theme-dark th, body.theme-dark td { border-bottom:1px solid #333; }
      body.theme-dark input, body.theme-dark select, body.theme-dark textarea { background:#1e1e1e; color:#eaeaea; border:1px solid #333; }
      body.theme-dark button { background:#2a2a2a; color:#eaeaea; border:1px solid #444; }
      body.theme-light { background:#fff; color:#111; }
      body.theme-dark #themeToggleBtn { background:#1a1a1a; color:#8ab4ff; border-color:#3769e6; }
      body.theme-dark #themeToggleBtn:hover { background:#1f3a75; color:#eaeaea; }
    </style>
    <script>
      function applyTheme(pref){ document.body.classList.remove('theme-dark','theme-light'); if(pref==='dark')document.body.classList.add('theme-dark'); if(pref==='light')document.body.classList.add('theme-light'); }
      function updateThemeButton(pref){ const b=document.getElementById('themeToggleBtn'); if(b) b.textContent = pref==='dark'?'テーマ: ダーク':(pref==='light'?'テーマ: ライト':'テーマ: 自動'); }
      function initTheme(){ const p=localStorage.getItem('theme')||'system'; applyTheme(p); updateThemeButton(p); }
      function toggleTheme(){ const cur=localStorage.getItem('theme')||'system'; const next=cur==='system'?'dark':(cur==='dark'?'light':'system'); localStorage.setItem('theme',next); applyTheme(next); updateThemeButton(next); }
      // 施設一覧の管理
      function loadFacilitiesForManage() {
        const tbody = document.getElementById('facManageRows');
        tbody.innerHTML = '<tr><td colspan="8">読み込み中...</td></tr>';
        google.script.run.withSuccessHandler(function(list){
          window._facList = list || [];
          renderFacilityRows();
        }).getFacilities({ limit: 500 });
      }
      function renderFacilityRows() {
        const tbody = document.getElementById('facManageRows');
        const kw = (document.getElementById('facFilterKw').value || '').toLowerCase();
        const pref = document.getElementById('facFilterPref').value || '';
        const type = document.getElementById('facFilterType').value || '';
        const list = (window._facList || []).filter(function(f){
          if (pref && f.prefecture !== pref) return false;
          if (type && f.facilityType !== type) return false;
          if (kw) {
            const hay = (f.name+' '+(f.address||'')+' '+(f.municipality||'')+' '+(f.notes||'')).toLowerCase();
            if (!hay.includes(kw)) return false;
          }
          return true;
        });
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="8">該当データがありません</td></tr>'; return; }
        let html = '';
        list.forEach(function(f){
          html += '<tr id="frow-'+f.id+'">'
            +'<td>'+escapeHtml(f.name)+'</td>'
            +'<td>'+escapeHtml(f.prefecture||'')+'</td>'
            +'<td>'+escapeHtml(f.municipality||'')+'</td>'
            +'<td>'+escapeHtml(f.facilityType||'')+'</td>'
            +'<td>'+escapeHtml(f.address||'')+'</td>'
            +'<td>'+escapeHtml(f.phone||'')+'</td>'
            +'<td class="row-actions">'
            +  '<button onclick="editFacility(\''+f.id+'\')">編集</button>'
            +  '<button onclick="openContactsPanel(\''+f.id+'\', \''+encodeURIComponent(f.name)+'\')">担当者</button>'
            +  '<button onclick="deleteFacilityReq(\''+f.id+'\')">削除</button>'
            +'</td>'
            +'</tr>';
        });
        tbody.innerHTML = html;
      }
      function escapeHtml(s){return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
      function deleteFacilityReq(id){
        if (!confirm('施設を削除します。担当者も全て削除されます。よろしいですか？')) return;
        google.script.run.withSuccessHandler(function(){
          loadFacilitiesForManage();
          if (document.getElementById('contactsFacilityId').value === id) {
            document.getElementById('contactsPanel').style.display = 'none';
          }
        }).deleteFacility(id);
      }
      function prefOptionsHtml(selected){
        const prefs=['東京都','神奈川県','千葉県','埼玉県','茨城県','栃木県','群馬県','山梨県'];
        let html='<option value="">-- 選択 --</option>';
        prefs.forEach(function(p){ html += '<option'+(p===selected?' selected':'')+'>'+p+'</option>'; });
        return html;
      }
      function facilityTypeCheckboxesHtml(selectedStr, id){
        const selected = new Set((selectedStr||'').split(/[／,、]/).map(s=>s.trim()).filter(Boolean));
        const make = (val,label)=> '<label style="display:inline-block;width:190px;"><input type="checkbox" name="e-type-'+id+'" class="etype" value="'+val.replace(/\"/g,'&quot;')+'"'+(selected.has(val)?' checked':'')+'> '+label+'</label>';
        let html = '<div style="display:flex;flex-wrap:wrap;gap:8px;">';
        const vals = [
          '居宅介護支援','訪問介護','通所介護','訪問看護','看護小規模多機能','特別養護老人ホーム','有料老人ホーム','サービス付高齢者住宅',
          '就労移行支援','就労継続支援A型','就労継続支援B型','就労定着支援','生活介護','自立訓練（生活訓練）','自立訓練（機能訓練）','共同生活援助（グループホーム）','短期入所（ショートステイ）','居宅介護（障害）','重度訪問介護','同行援護','行動援護','移動支援','施設入所支援',
    '特定相談支援（計画相談）','障害児相談支援','児童発達支援','放課後等デイサービス','保育所等訪問支援','児童発達支援センター','ケアマネ','医療機関','行政機関','市役所','その他'
        ];
        vals.forEach(v=>{ html += make(v,v); });
        html += '</div>';
        // その他詳細入力
        const otherDetail = Array.from(selected).find(s=>s.startsWith('その他:'));
        const otherVal = otherDetail ? otherDetail.substring(3) : '';
        html += '<div id="e-type-other-wrap-'+id+'" style="margin-top:8px;'+(selected.has('その他')||otherDetail?'':'display:none;')+'">'
              + '<label>その他詳細 <input type="text" id="e-type-other-'+id+'" placeholder="種類を入力" value="'+(otherVal||'').replace(/\"/g,'&quot;')+'"></label>'
              + '</div>';
        return html;
      }
      function loadMunicipalityOptionsForRow(id, pref, current){
        const sel = document.getElementById('e-mun-'+id);
        sel.innerHTML = '<option value="">読み込み中...</option>';
        if (!pref) { sel.innerHTML = '<option value="">-- 先に都道府県 --</option>'; return; }
        google.script.run.withSuccessHandler(function(list){
          let html='<option value="">-- 選択 --</option>';
          list.forEach(function(m){
            const val=m.municipality; html += '<option'+(val===current?' selected':'')+'>'+val+'</option>';
          });
          sel.innerHTML = html;
        }).getMunicipalities({ prefecture: pref });
      }
      function editFacility(id){
        const tr = document.getElementById('frow-'+id);
        if (!tr) return;
        const tds = tr.querySelectorAll('td');
        const name = tds[0].textContent; const pref = tds[1].textContent; const mun = tds[2].textContent; const type = tds[3].textContent; const addr = tds[4].textContent; const phone = tds[5].textContent;
        tds[0].innerHTML = '<input id="e-name-'+id+'" value="'+name.replace(/"/g,'&quot;')+'">';
        tds[1].innerHTML = '<select id="e-pref-'+id+'">'+prefOptionsHtml(pref)+'</select>';
        tds[2].innerHTML = '<select id="e-mun-'+id+'"><option value="">-- 先に都道府県 --</option></select>';
        tds[3].innerHTML = facilityTypeCheckboxesHtml(type, id);
        tds[4].innerHTML = '<input id="e-addr-'+id+'" value="'+addr.replace(/"/g,'&quot;')+'">';
        tds[5].innerHTML = '<input id="e-phone-'+id+'" value="'+phone.replace(/"/g,'&quot;')+'">';
        tds[6].innerHTML = '<button onclick="saveFacility(\''+id+'\')">保存</button> <button onclick="loadFacilitiesForManage()">キャンセル</button>';
        // 県選択イベントで市区町村をロード
        document.getElementById('e-pref-'+id).addEventListener('change', function(){
          loadMunicipalityOptionsForRow(id, this.value, '');
        });
        // 初期の市区町村一覧読み込み
        if (pref) loadMunicipalityOptionsForRow(id, pref, mun);
        // その他チェックの表示制御
        tr.querySelectorAll('input[name="e-type-'+id+'"]').forEach(function(cb){
          cb.addEventListener('change', function(){
            if (this.value==='その他') {
              const wrap = document.getElementById('e-type-other-wrap-'+id);
              wrap.style.display = this.checked ? 'block':'none';
              if (!this.checked) document.getElementById('e-type-other-'+id).value='';
            }
          });
        });
      }
      function saveFacility(id){
        const data = {
          id: id,
          name: document.getElementById('e-name-'+id).value,
          prefecture: document.getElementById('e-pref-'+id).value,
          municipality: document.getElementById('e-mun-'+id).value,
          facilityType: (function(){
            const cbs = Array.from(document.querySelectorAll('input[name="e-type-'+id+'"]:checked'));
            let vals = cbs.map(cb=>cb.value);
            const otherIdx = vals.indexOf('その他');
            if (otherIdx !== -1) {
              const ov = (document.getElementById('e-type-other-'+id).value||'').trim();
              if (ov) { vals[otherIdx] = 'その他:'+ov; } else { vals.splice(otherIdx,1); }
            }
            return vals.join('／');
          })(),
          address: document.getElementById('e-addr-'+id).value,
          phone: document.getElementById('e-phone-'+id).value,
        };
        if (!data.name) { alert('施設名は必須です'); return; }
        if (!data.facilityType) { alert('事業所種類を1つ以上選択してください'); return; }
        google.script.run.withSuccessHandler(function(){
          loadFacilitiesForManage();
        }).updateFacility(data);
      }

      // 担当者パネル
      function openContactsPanel(facilityId, encodedName){
        document.getElementById('contactsPanel').style.display = 'block';
        document.getElementById('contactsFacilityId').value = facilityId;
        document.getElementById('contactsFacilityName').textContent = decodeURIComponent(encodedName);
        loadContacts(facilityId);
      }
      function loadContacts(facilityId){
        const tbody = document.getElementById('contactsRows');
        tbody.innerHTML = '<tr><td colspan="6">読み込み中...</td></tr>';
        google.script.run.withSuccessHandler(function(list){
          window._contactsCacheManage = list || [];
          renderContacts();
        }).getFacilityContacts({ facilityId: facilityId });
      }
      function renderContacts(){
        const tbody = document.getElementById('contactsRows');
        const kw = (document.getElementById('contactsFilter').value || '').toLowerCase();
        const list = (window._contactsCacheManage || []).filter(function(c){
          if (!kw) return true;
          const hay = ((c.contactName||'')+' '+(c.contactNotes||'')).toLowerCase();
          return hay.includes(kw);
        });
        if (!list.length) { tbody.innerHTML = '<tr><td colspan="6">担当者がいません</td></tr>'; return; }
        let html = '';
        list.forEach(function(c){
          html += '<tr id="crow-'+c.id+'">'
           + '<td class="c-name">'+escapeHtml(c.contactName||'')+'</td>'
           + '<td class="c-phone">'+escapeHtml(c.contactPhone||'')+'</td>'
           + '<td class="c-notes">'+escapeHtml(c.contactNotes||'')+'</td>'
           + '<td>'+(c.cardFileId ? ('<img src="https://drive.google.com/uc?export=view&id='+escapeHtml(c.cardFileId)+'" style="max-width:80px;max-height:60px;object-fit:cover;border:1px solid #ccc;">') : '—')+'</td>'
           + '<td>'+escapeHtml(c.createdAt||'')+'</td>'
           + '<td>'
           +   '<button onclick="editContactM(\''+c.id+'\')">編集</button> '
           +   '<button onclick="triggerCardUploadM(\''+c.id+'\')">名刺</button> '
           +   '<button onclick="deleteContactM(\''+c.id+'\')">削除</button>'
           + '</td>'
           + '</tr>';
        });
        tbody.innerHTML = html;
      }
      function addContactM(){
        const fid = document.getElementById('contactsFacilityId').value;
        const name = document.getElementById('m-contactName').value.trim();
        const phone = document.getElementById('m-contactPhone').value.trim();
        const notes = document.getElementById('m-contactNotes').value.trim();
        if (!fid) { alert('施設が選択されていません'); return; }
        if (!name) { alert('担当者名を入力してください'); return; }
        google.script.run.withSuccessHandler(function(){
          document.getElementById('m-contactName').value = '';
          document.getElementById('m-contactPhone').value = '';
          document.getElementById('m-contactNotes').value = '';
          loadContacts(fid);
        }).addFacilityContact({ facilityId: fid, contactName: name, contactPhone: phone, contactNotes: notes });
      }
      function editContactM(id){
        const tr = document.getElementById('crow-'+id);
        if (!tr) return;
        const name = tr.querySelector('.c-name').textContent;
        const phone = tr.querySelector('.c-phone').textContent;
        const notes = tr.querySelector('.c-notes').textContent;
        tr.querySelector('.c-name').innerHTML = '<input id="ce-name-'+id+'" value="'+name.replace(/"/g,'&quot;')+'">';
        tr.querySelector('.c-phone').innerHTML = '<input id="ce-phone-'+id+'" value="'+phone.replace(/"/g,'&quot;')+'">';
        tr.querySelector('.c-notes').innerHTML = '<textarea id="ce-notes-'+id+'" rows="2">'+notes.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</textarea>';
        tr.querySelector('td:last-child').innerHTML = '<button onclick="saveContactM(\''+id+'\')">保存</button> <button onclick="loadContacts(document.getElementById(\'contactsFacilityId\').value)">キャンセル</button>';
      }
      function saveContactM(id){
        const name = document.getElementById('ce-name-'+id).value.trim();
        const phone = document.getElementById('ce-phone-'+id).value.trim();
        const notes = document.getElementById('ce-notes-'+id).value.trim();
        if (!name) { alert('担当者名は必須です'); return; }
        google.script.run.withSuccessHandler(function(){
          const fid = document.getElementById('contactsFacilityId').value;
          loadContacts(fid);
        }).updateFacilityContact({ id: id, contactName: name, contactPhone: phone, contactNotes: notes });
      }
      function deleteContactM(id){
        if (!confirm('担当者を削除します。よろしいですか？')) return;
        google.script.run.withSuccessHandler(function(){
          const fid = document.getElementById('contactsFacilityId').value;
          loadContacts(fid);
        }).deleteFacilityContact(id);
      }
      function triggerCardUploadM(id){
        const input = document.getElementById('m-cardUpload');
        input.dataset.contactId = id;
        input.click();
      }
      function handleCardFileChangeM(ev){
        const input = ev.target;
        const contactId = input.dataset.contactId;
        if (!contactId || !input.files || !input.files.length) return;
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
          const dataUrl = e.target.result;
          google.script.run.withSuccessHandler(function(){
            const fid = document.getElementById('contactsFacilityId').value;
            loadContacts(fid);
          }).uploadFacilityContactCard({ contactId: contactId, dataUrl: dataUrl, filename: file.name });
        };
        reader.readAsDataURL(file);
        input.value = '';
      }

      window.addEventListener('load', function(){ initTheme(); loadFacilitiesForManage(); });
    </script>
  </head>
  <body>
    <nav>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=index">メニュー</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=facilities">施設登録</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=visits">問い合わせ記録</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=reports">営業報告</a>
      <a href="<?= ScriptApp.getService().getUrl(); ?>?page=employees">社員</a>
      <button id="themeToggleBtn" type="button" onclick="toggleTheme()">テーマ: 自動</button>
    </nav>

    <h1>施設・担当者 管理</h1>
    <div class="grid">
      <section>
        <h2>施設一覧</h2>
        <div class="flex" style="margin-bottom:8px;">
          <input id="facFilterKw" type="text" placeholder="キーワード（施設名・住所・市区町村・備考）" oninput="renderFacilityRows()" style="flex:1;">
          <select id="facFilterPref" onchange="renderFacilityRows()">
            <option value="">都道府県</option>
            <option>東京都</option><option>神奈川県</option><option>千葉県</option><option>埼玉県</option><option>茨城県</option><option selected>栃木県</option><option>群馬県</option><option>山梨県</option>
          </select>
          <input id="facFilterType" placeholder="種類で絞り込み（完全一致）" oninput="renderFacilityRows()" />
        </div>
        <div class="table-wrap">
        <table>
          <thead><tr><th>施設名</th><th>都道府県</th><th>市区町村</th><th>種類</th><th>住所</th><th>電話</th><th></th></tr></thead>
          <tbody id="facManageRows"><tr><td colspan="8">読み込み中...</td></tr></tbody>
        </table>
        </div>
      </section>
      <section>
        <h2>担当者</h2>
        <div id="contactsPanel" style="display:none;">
          <div class="muted">施設: <span id="contactsFacilityName"></span></div>
          <input type="hidden" id="contactsFacilityId" />
          <div style="margin-top:8px;">
            <input id="m-contactName" placeholder="担当者名"> 
            <input id="m-contactPhone" placeholder="電話">
            <input id="m-contactNotes" placeholder="備考">
            <button onclick="addContactM()">追加</button>
          </div>
          <div style="margin-top:8px;">
            <input id="contactsFilter" type="text" placeholder="担当者フィルタ（氏名・備考）" oninput="renderContacts()">
          </div>
          <div class="table-wrap">
          <table>
            <thead><tr><th>氏名</th><th>電話</th><th>備考</th><th>名刺</th><th>登録日時</th><th></th></tr></thead>
            <tbody id="contactsRows"><tr><td colspan="6">施設を選択してください</td></tr></tbody>
          </table>
          </div>
        </div>
        <div id="contactsPlaceholder" class="muted" style="margin-top:8px;">左の一覧から「担当者」ボタンで施設を選択してください。</div>
      </section>
    </div>

    <!-- 名刺アップロード hidden input -->
    <input id="m-cardUpload" type="file" accept="image/*" style="display:none" onchange="handleCardFileChangeM(event)">
  </body>
</html>
